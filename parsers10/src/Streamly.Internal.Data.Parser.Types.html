<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ExistentialQuantification          #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-3"></a><span>
</span><a name="line-4"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- Module      : Streamly.Parser.Types</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- Copyright   : (c) 2020 Composewell Technologies</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- License     : BSD3</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- Maintainer  : streamly@composewell.com</span><span>
</span><a name="line-9"></a><span class="hs-comment">-- Stability   : experimental</span><span>
</span><a name="line-10"></a><span class="hs-comment">-- Portability : GHC</span><span>
</span><a name="line-11"></a><span class="hs-comment">--</span><span>
</span><a name="line-12"></a><span class="hs-comment">-- Streaming and backtracking parsers.</span><span>
</span><a name="line-13"></a><span class="hs-comment">--</span><span>
</span><a name="line-14"></a><span class="hs-comment">-- Parsers just extend folds.  Please read the 'Fold' design notes in</span><span>
</span><a name="line-15"></a><span class="hs-comment">-- &quot;Streamly.Internal.Data.Fold.Types&quot; for background on the design.</span><span>
</span><a name="line-16"></a><span class="hs-comment">--</span><span>
</span><a name="line-17"></a><span class="hs-comment">-- = Parser Design</span><span>
</span><a name="line-18"></a><span class="hs-comment">--</span><span>
</span><a name="line-19"></a><span class="hs-comment">-- The 'Parser' type or a parsing fold is a generalization of the 'Fold' type.</span><span>
</span><a name="line-20"></a><span class="hs-comment">-- The 'Fold' type /always/ succeeds on each input. Therefore, it does not need</span><span>
</span><a name="line-21"></a><span class="hs-comment">-- to buffer the input. In contrast, a 'Parser' may fail and backtrack to</span><span>
</span><a name="line-22"></a><span class="hs-comment">-- replay the input again to explore another branch of the parser. Therefore,</span><span>
</span><a name="line-23"></a><span class="hs-comment">-- it needs to buffer the input. Therefore, a 'Parser' is a fold with some</span><span>
</span><a name="line-24"></a><span class="hs-comment">-- additional requirements.  To summarize, unlike a 'Fold', a 'Parser':</span><span>
</span><a name="line-25"></a><span class="hs-comment">--</span><span>
</span><a name="line-26"></a><span class="hs-comment">-- 1. may not generate a new value of the accumulator on every input, it may</span><span>
</span><a name="line-27"></a><span class="hs-comment">-- generate a new accumulator only after consuming multiple input elements</span><span>
</span><a name="line-28"></a><span class="hs-comment">-- (e.g. takeEQ).</span><span>
</span><a name="line-29"></a><span class="hs-comment">-- 2. on success may return some unconsumed input (e.g. takeWhile)</span><span>
</span><a name="line-30"></a><span class="hs-comment">-- 3. may fail and return all input without consuming it (e.g. satisfy)</span><span>
</span><a name="line-31"></a><span class="hs-comment">-- 4. backtrack and start inspecting the past input again (e.g. alt)</span><span>
</span><a name="line-32"></a><span class="hs-comment">--</span><span>
</span><a name="line-33"></a><span class="hs-comment">-- These use cases require buffering and replaying of input.  To facilitate</span><span>
</span><a name="line-34"></a><span class="hs-comment">-- this, the step function of the 'Fold' is augmented to return the next state</span><span>
</span><a name="line-35"></a><span class="hs-comment">-- of the fold along with a command tag using a 'Step' functor, the tag tells</span><span>
</span><a name="line-36"></a><span class="hs-comment">-- the fold driver to manipulate the future input as the parser wishes. The</span><span>
</span><a name="line-37"></a><span class="hs-comment">-- 'Step' functor provides the following commands to the fold driver</span><span>
</span><a name="line-38"></a><span class="hs-comment">-- corresponding to the use cases outlined in the previous para:</span><span>
</span><a name="line-39"></a><span class="hs-comment">--</span><span>
</span><a name="line-40"></a><span class="hs-comment">-- 1. 'Skip': hold (buffer) the input or go back to a previous position in the stream</span><span>
</span><a name="line-41"></a><span class="hs-comment">-- 2. 'Yield', 'Stop': tell how much input is unconsumed</span><span>
</span><a name="line-42"></a><span class="hs-comment">-- 3. 'Error': indicates that the parser has failed without a result</span><span>
</span><a name="line-43"></a><span class="hs-comment">--</span><span>
</span><a name="line-44"></a><span class="hs-comment">-- = How a Parser Works?</span><span>
</span><a name="line-45"></a><span class="hs-comment">--</span><span>
</span><a name="line-46"></a><span class="hs-comment">-- A parser is just like a fold, it keeps consuming inputs from the stream and</span><span>
</span><a name="line-47"></a><span class="hs-comment">-- accumulating them in an accumulator. The accumulator of the parser could be</span><span>
</span><a name="line-48"></a><span class="hs-comment">-- a singleton value or it could be a collection of values e.g. a list.</span><span>
</span><a name="line-49"></a><span class="hs-comment">--</span><span>
</span><a name="line-50"></a><span class="hs-comment">-- The parser may build a new output value from multiple input items. When it</span><span>
</span><a name="line-51"></a><span class="hs-comment">-- consumes an input item but needs more input to build a complete output item</span><span>
</span><a name="line-52"></a><span class="hs-comment">-- it uses @Skip 0 s@, yielding the intermediate state @s@ and asking the</span><span>
</span><a name="line-53"></a><span class="hs-comment">-- driver to provide more input.  When the parser determines that a new output</span><span>
</span><a name="line-54"></a><span class="hs-comment">-- value is complete it can use a @Stop n b@ to terminate the parser with @n@</span><span>
</span><a name="line-55"></a><span class="hs-comment">-- items of input unused and the final value of the accumulator returned as</span><span>
</span><a name="line-56"></a><span class="hs-comment">-- @b@. If at any time the parser determines that the parse has failed it can</span><span>
</span><a name="line-57"></a><span class="hs-comment">-- return @Error err@.</span><span>
</span><a name="line-58"></a><span class="hs-comment">--</span><span>
</span><a name="line-59"></a><span class="hs-comment">-- A parser building a collection of values (e.g. a list) can use the @Yield@</span><span>
</span><a name="line-60"></a><span class="hs-comment">-- constructor whenever a new item in the output collection is generated. If a</span><span>
</span><a name="line-61"></a><span class="hs-comment">-- parser building a collection of values has yielded at least one value then</span><span>
</span><a name="line-62"></a><span class="hs-comment">-- it considered successful and cannot fail after that. In the current</span><span>
</span><a name="line-63"></a><span class="hs-comment">-- implementation, this is not automatically enforced, there is a rule that the</span><span>
</span><a name="line-64"></a><span class="hs-comment">-- parser MUST use only @Stop@ for termination after the first @Yield@, it</span><span>
</span><a name="line-65"></a><span class="hs-comment">-- cannot use @Error@. It may be possible to change the implementation so that</span><span>
</span><a name="line-66"></a><span class="hs-comment">-- this rule is not required, but there may be some performance cost to it.</span><span>
</span><a name="line-67"></a><span class="hs-comment">--</span><span>
</span><a name="line-68"></a><span class="hs-comment">-- 'Streamly.Internal.Data.Parser.takeWhile' and</span><span>
</span><a name="line-69"></a><span class="hs-comment">-- 'Streamly.Internal.Data.Parser.some' combinators are good examples of</span><span>
</span><a name="line-70"></a><span class="hs-comment">-- efficient implementations using all features of this representation.  It is</span><span>
</span><a name="line-71"></a><span class="hs-comment">-- possible to idiomatically build a collection of parsed items using a</span><span>
</span><a name="line-72"></a><span class="hs-comment">-- singleton parser and @Alternative@ instance instead of using a</span><span>
</span><a name="line-73"></a><span class="hs-comment">-- multi-yield parser.  However, this implementation is amenable to stream</span><span>
</span><a name="line-74"></a><span class="hs-comment">-- fusion and can therefore be much faster.</span><span>
</span><a name="line-75"></a><span class="hs-comment">--</span><span>
</span><a name="line-76"></a><span class="hs-comment">-- = Error Handling</span><span>
</span><a name="line-77"></a><span class="hs-comment">--</span><span>
</span><a name="line-78"></a><span class="hs-comment">-- When a parser's @step@ function is invoked it may iterminate by either a</span><span>
</span><a name="line-79"></a><span class="hs-comment">-- 'Stop' or an 'Error' return value. In an 'Alternative' composition an error</span><span>
</span><a name="line-80"></a><span class="hs-comment">-- return can make the composed parser backtrack and try another parser.</span><span>
</span><a name="line-81"></a><span class="hs-comment">--</span><span>
</span><a name="line-82"></a><span class="hs-comment">-- If the stream stops before a parser could terminate then we use the</span><span>
</span><a name="line-83"></a><span class="hs-comment">-- @extract@ function of the parser to retrieve the last yielded value of the</span><span>
</span><a name="line-84"></a><span class="hs-comment">-- parser. If the parser has yielded at least one value then @extract@ MUST</span><span>
</span><a name="line-85"></a><span class="hs-comment">-- return a value without throwing an error, otherwise it uses the 'ParseError'</span><span>
</span><a name="line-86"></a><span class="hs-comment">-- exception to throw an error.</span><span>
</span><a name="line-87"></a><span class="hs-comment">--</span><span>
</span><a name="line-88"></a><span class="hs-comment">-- We chose the exception throwing mechanism for @extract@ instead of using an</span><span>
</span><a name="line-89"></a><span class="hs-comment">-- explicit error return via an 'Either' type for keeping the interface simple</span><span>
</span><a name="line-90"></a><span class="hs-comment">-- as most of the time we do not need to catch the error in intermediate</span><span>
</span><a name="line-91"></a><span class="hs-comment">-- layers. Note that we cannot use exception throwing mechanism in @step@</span><span>
</span><a name="line-92"></a><span class="hs-comment">-- function because of performance reasons. 'Error' constructor in that case</span><span>
</span><a name="line-93"></a><span class="hs-comment">-- allows loop fusion and better performance.</span><span>
</span><a name="line-94"></a><span class="hs-comment">--</span><span>
</span><a name="line-95"></a><span class="hs-comment">-- = Future Work</span><span>
</span><a name="line-96"></a><span class="hs-comment">--</span><span>
</span><a name="line-97"></a><span class="hs-comment">-- It may make sense to move &quot;takeWhile&quot; type of parsers, which cannot fail but</span><span>
</span><a name="line-98"></a><span class="hs-comment">-- need some lookahead, to splitting folds.  This will allow such combinators</span><span>
</span><a name="line-99"></a><span class="hs-comment">-- to be accepted where we need an unfailing &quot;Fold&quot; type.</span><span>
</span><a name="line-100"></a><span class="hs-comment">--</span><span>
</span><a name="line-101"></a><span class="hs-comment">-- Based on application requirements it should be possible to design even a</span><span>
</span><a name="line-102"></a><span class="hs-comment">-- richer interface to manipulate the input stream/buffer. For example, we</span><span>
</span><a name="line-103"></a><span class="hs-comment">-- could randomly seek into the stream in the forward or reverse directions or</span><span>
</span><a name="line-104"></a><span class="hs-comment">-- we can even seek to the end or from the end or seek from the beginning.</span><span>
</span><a name="line-105"></a><span class="hs-comment">--</span><span>
</span><a name="line-106"></a><span class="hs-comment">-- We can distribute and scan/parse a stream using both folds and parsers and</span><span>
</span><a name="line-107"></a><span class="hs-comment">-- merge the resulting streams using different merge strategies (e.g.</span><span>
</span><a name="line-108"></a><span class="hs-comment">-- interleaving or serial).</span><span>
</span><a name="line-109"></a><span>
</span><a name="line-110"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Streamly.Internal.Data.Parser.Types</span><span>
</span><a name="line-111"></a><span>    </span><span class="hs-special">(</span><span>
</span><a name="line-112"></a><span>      </span><a href="Streamly.Internal.Data.Parser.Types.html#Step"><span class="hs-identifier hs-type">Step</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-113"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-type">Parser</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-114"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#ParseError"><span class="hs-identifier hs-type">ParseError</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-115"></a><span>
</span><a name="line-116"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#yield"><span class="hs-identifier hs-var">yield</span></a><span>
</span><a name="line-117"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#yieldM"><span class="hs-identifier hs-var">yieldM</span></a><span>
</span><a name="line-118"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#splitWith"><span class="hs-identifier hs-var">splitWith</span></a><span>
</span><a name="line-119"></a><span>
</span><a name="line-120"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#die"><span class="hs-identifier hs-var">die</span></a><span>
</span><a name="line-121"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#dieM"><span class="hs-identifier hs-var">dieM</span></a><span>
</span><a name="line-122"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#splitSome"><span class="hs-identifier hs-var">splitSome</span></a><span>
</span><a name="line-123"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#splitMany"><span class="hs-identifier hs-var">splitMany</span></a><span>
</span><a name="line-124"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#alt"><span class="hs-identifier hs-var">alt</span></a><span>
</span><a name="line-125"></a><span>    </span><span class="hs-special">)</span><span>
</span><a name="line-126"></a><span class="hs-keyword">where</span><span>
</span><a name="line-127"></a><span>
</span><a name="line-128"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Applicative</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Alternative</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-129"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Exception</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">assert</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Exception</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-130"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadPlus</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-131"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Catch</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadCatch</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">try</span><span class="hs-special">)</span><span>
</span><a name="line-132"></a><span>
</span><a name="line-133"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Fusion.Plugin.Types</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Fuse</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-134"></a><span class="hs-keyword">import</span><span> </span><a href="Streamly.Internal.Data.Fold.html"><span class="hs-identifier">Streamly.Internal.Data.Fold</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-type">Fold</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Streamly.Internal.Data.Fold.html#toList"><span class="hs-identifier hs-var">toList</span></a><span class="hs-special">)</span><span>
</span><a name="line-135"></a><span class="hs-keyword">import</span><span> </span><a href="Streamly.Internal.Data.Strict.html"><span class="hs-identifier">Streamly.Internal.Data.Strict</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Strict.html#Tuple3%27"><span class="hs-identifier hs-type">Tuple3'</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-136"></a><span>
</span><a name="line-137"></a><span class="hs-comment">-- | The return type of a 'Parser' step.</span><span>
</span><a name="line-138"></a><span class="hs-comment">--</span><span>
</span><a name="line-139"></a><span class="hs-comment">-- A parser is driven by a parse driver one step at a time, at any time the</span><span>
</span><a name="line-140"></a><span class="hs-comment">-- driver may @extract@ the result of the parser. The parser may ask the driver</span><span>
</span><a name="line-141"></a><span class="hs-comment">-- to backtrack at any point, therefore, the driver holds the input up to a</span><span>
</span><a name="line-142"></a><span class="hs-comment">-- point of no return in a backtracking buffer.  The buffer grows or shrinks</span><span>
</span><a name="line-143"></a><span class="hs-comment">-- based on the return values of the parser step execution.</span><span>
</span><a name="line-144"></a><span class="hs-comment">--</span><span>
</span><a name="line-145"></a><span class="hs-comment">-- When a parser step is executed it generates a new intermediate state of the</span><span>
</span><a name="line-146"></a><span class="hs-comment">-- parse result along with a command to the driver. The command tells the</span><span>
</span><a name="line-147"></a><span class="hs-comment">-- driver whether to keep the input stream for a potential backtracking later</span><span>
</span><a name="line-148"></a><span class="hs-comment">-- on or drop it, and how much to keep. The constructors of 'Step' represent</span><span>
</span><a name="line-149"></a><span class="hs-comment">-- the commands to the driver.</span><span>
</span><a name="line-150"></a><span class="hs-comment">--</span><span>
</span><a name="line-151"></a><span class="hs-comment">-- /Internal/</span><span>
</span><a name="line-152"></a><span class="hs-comment">--</span><span>
</span><a name="line-153"></a><span class="hs-pragma">{-# ANN</span><span> </span><span class="hs-pragma">type</span><span> </span><span class="hs-pragma">Step</span><span> </span><span class="hs-pragma">Fuse</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-154"></a><span class="hs-keyword">data</span><span> </span><a name="Step"><a href="Streamly.Internal.Data.Parser.Types.html#Step"><span class="hs-identifier">Step</span></a></a><span> </span><a name="local-6989586621679161078"><a href="#local-6989586621679161078"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621679161079"><a href="#local-6989586621679161079"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-155"></a><span>      </span><a name="Yield"><a href="Streamly.Internal.Data.Parser.Types.html#Yield"><span class="hs-identifier">Yield</span></a></a><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><a href="#local-6989586621679161078"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-156"></a><span>      </span><span class="hs-comment">-- ^ @Yield offset state@ indicates that the parser has yielded a new</span><span>
</span><a name="line-157"></a><span>      </span><span class="hs-comment">-- result which is a point of no return. The result can be extracted</span><span>
</span><a name="line-158"></a><span>      </span><span class="hs-comment">-- using @extract@. The driver drops the buffer except @offset@ elements</span><span>
</span><a name="line-159"></a><span>      </span><span class="hs-comment">-- before the current position in stream. The rule is that if a parser</span><span>
</span><a name="line-160"></a><span>      </span><span class="hs-comment">-- has yielded at least once it cannot return a failure result.</span><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="Skip"><a href="Streamly.Internal.Data.Parser.Types.html#Skip"><span class="hs-identifier">Skip</span></a></a><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><a href="#local-6989586621679161078"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-163"></a><span>    </span><span class="hs-comment">-- ^ @Skip offset state@ indicates that the parser has consumed the current</span><span>
</span><a name="line-164"></a><span>    </span><span class="hs-comment">-- input but no new result has been generated. A new @state@ is generated.</span><span>
</span><a name="line-165"></a><span>    </span><span class="hs-comment">-- However, if we use @extract@ on @state@ it will generate a result from</span><span>
</span><a name="line-166"></a><span>    </span><span class="hs-comment">-- the previous @Yield@.  When @offset@ is non-zero it is a backward offset</span><span>
</span><a name="line-167"></a><span>    </span><span class="hs-comment">-- from the current position in the stream from which the driver will feed</span><span>
</span><a name="line-168"></a><span>    </span><span class="hs-comment">-- the next input to the parser. The offset cannot be beyond the latest</span><span>
</span><a name="line-169"></a><span>    </span><span class="hs-comment">-- point of no return created by @Yield@.</span><span>
</span><a name="line-170"></a><span>
</span><a name="line-171"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="Stop"><a href="Streamly.Internal.Data.Parser.Types.html#Stop"><span class="hs-identifier">Stop</span></a></a><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><a href="#local-6989586621679161079"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-172"></a><span>    </span><span class="hs-comment">-- ^ @Stop offset state@ asks the driver to stop driving the parser because</span><span>
</span><a name="line-173"></a><span>    </span><span class="hs-comment">-- it has reached a fixed point and further input will not change the</span><span>
</span><a name="line-174"></a><span>    </span><span class="hs-comment">-- result.  @offset@ is the count of unused elements which includes the</span><span>
</span><a name="line-175"></a><span>    </span><span class="hs-comment">-- element on which 'Stop' occurred.  Once a fold stops, driving it further</span><span>
</span><a name="line-176"></a><span>    </span><span class="hs-comment">-- may produce undefined behavior.</span><span>
</span><a name="line-177"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="Error"><a href="Streamly.Internal.Data.Parser.Types.html#Error"><span class="hs-identifier">Error</span></a></a><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-178"></a><span>    </span><span class="hs-comment">-- ^ An error makes the parser backtrack to the last checkpoint and try</span><span>
</span><a name="line-179"></a><span>    </span><span class="hs-comment">-- another alternative.</span><span>
</span><a name="line-180"></a><span>
</span><a name="line-181"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#Step"><span class="hs-identifier hs-type">Step</span></a><span> </span><a href="#local-6989586621679161135"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-182"></a><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">fmap</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-183"></a><span>    </span><a name="local-3458764513820541101"><span class="hs-identifier">fmap</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#Yield"><span class="hs-identifier hs-var">Yield</span></a><span> </span><a name="local-6989586621679161136"><a href="#local-6989586621679161136"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679161137"><a href="#local-6989586621679161137"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Yield"><span class="hs-identifier hs-var">Yield</span></a><span> </span><a href="#local-6989586621679161136"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679161137"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-184"></a><span>    </span><span class="hs-identifier">fmap</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#Skip"><span class="hs-identifier hs-var">Skip</span></a><span> </span><a name="local-6989586621679161138"><a href="#local-6989586621679161138"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679161139"><a href="#local-6989586621679161139"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Skip"><span class="hs-identifier hs-var">Skip</span></a><span> </span><a href="#local-6989586621679161138"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679161139"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-185"></a><span>    </span><span class="hs-identifier">fmap</span><span> </span><a name="local-6989586621679161140"><a href="#local-6989586621679161140"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a name="local-6989586621679161141"><a href="#local-6989586621679161141"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679161142"><a href="#local-6989586621679161142"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a href="#local-6989586621679161141"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679161140"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679161142"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-186"></a><span>    </span><span class="hs-identifier">fmap</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#Error"><span class="hs-identifier hs-var">Error</span></a><span> </span><a name="local-6989586621679161143"><a href="#local-6989586621679161143"><span class="hs-identifier">err</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Error"><span class="hs-identifier hs-var">Error</span></a><span> </span><a href="#local-6989586621679161143"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-187"></a><span>
</span><a name="line-188"></a><span class="hs-comment">-- | A parser is a fold that can fail and is represented as @Parser step</span><span>
</span><a name="line-189"></a><span class="hs-comment">-- initial extract@. Before we drive a parser we call the @initial@ action to</span><span>
</span><a name="line-190"></a><span class="hs-comment">-- retrieve the initial state of the fold. The parser driver invokes @step@</span><span>
</span><a name="line-191"></a><span class="hs-comment">-- with the state returned by the previous step and the next input element. It</span><span>
</span><a name="line-192"></a><span class="hs-comment">-- results into a new state and a command to the driver represented by 'Step'</span><span>
</span><a name="line-193"></a><span class="hs-comment">-- type. The driver keeps invoking the step function until it stops or fails.</span><span>
</span><a name="line-194"></a><span class="hs-comment">-- At any point of time the driver can call @extract@ to inspect the result of</span><span>
</span><a name="line-195"></a><span class="hs-comment">-- the fold. It may result in an error or an output value.</span><span>
</span><a name="line-196"></a><span class="hs-comment">--</span><span>
</span><a name="line-197"></a><span class="hs-comment">-- /Internal/</span><span>
</span><a name="line-198"></a><span class="hs-comment">--</span><span>
</span><a name="line-199"></a><span class="hs-keyword">data</span><span> </span><a name="Parser"><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier">Parser</span></a></a><span> </span><a name="local-6989586621679161074"><a href="#local-6989586621679161074"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679161075"><a href="#local-6989586621679161075"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679161076"><a href="#local-6989586621679161076"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-200"></a><span>    </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679161077"><a href="#local-6989586621679161077"><span class="hs-identifier">s</span></a></a><span class="hs-operator">.</span><span> </span><a name="Parser"><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier">Parser</span></a></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679161077"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679161075"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679161074"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#Step"><span class="hs-identifier hs-type">Step</span></a><span> </span><a href="#local-6989586621679161077"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679161076"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679161074"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679161077"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679161077"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679161074"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679161076"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-201"></a><span>
</span><a name="line-202"></a><span class="hs-comment">-- | This exception is used for two purposes:</span><span>
</span><a name="line-203"></a><span class="hs-comment">--</span><span>
</span><a name="line-204"></a><span class="hs-comment">-- * When a parser ultimately fails, the user of the parser is intimated via</span><span>
</span><a name="line-205"></a><span class="hs-comment">--    this exception.</span><span>
</span><a name="line-206"></a><span class="hs-comment">-- * When the &quot;extract&quot; function of a parser needs to throw an error.</span><span>
</span><a name="line-207"></a><span class="hs-comment">--</span><span>
</span><a name="line-208"></a><span class="hs-comment">-- /Internal/</span><span>
</span><a name="line-209"></a><span class="hs-comment">--</span><span>
</span><a name="line-210"></a><span class="hs-keyword">newtype</span><span> </span><a name="ParseError"><a href="Streamly.Internal.Data.Parser.Types.html#ParseError"><span class="hs-identifier">ParseError</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="ParseError"><a href="Streamly.Internal.Data.Parser.Types.html#ParseError"><span class="hs-identifier">ParseError</span></a></a><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-211"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-identifier hs-type">Show</span><span>
</span><a name="line-212"></a><span>
</span><a name="line-213"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Exception</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#ParseError"><span class="hs-identifier hs-type">ParseError</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-214"></a><span>    </span><a name="local-8214565720323788852"><span class="hs-identifier">displayException</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#ParseError"><span class="hs-identifier hs-var">ParseError</span></a><span> </span><a name="local-6989586621679161134"><a href="#local-6989586621679161134"><span class="hs-identifier">err</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679161134"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-215"></a><span>
</span><a name="line-216"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><a href="#local-6989586621679161123"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-type">Parser</span></a><span> </span><a href="#local-6989586621679161123"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679161124"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-217"></a><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">fmap</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-218"></a><span>    </span><a name="local-3458764513820541101"><span class="hs-identifier">fmap</span></a><span> </span><a name="local-6989586621679161125"><a href="#local-6989586621679161125"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-var">Parser</span></a><span> </span><a name="local-6989586621679161126"><a href="#local-6989586621679161126"><span class="hs-identifier">step1</span></a></a><span> </span><a name="local-6989586621679161127"><a href="#local-6989586621679161127"><span class="hs-identifier">initial</span></a></a><span> </span><a name="local-6989586621679161128"><a href="#local-6989586621679161128"><span class="hs-identifier">extract</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-219"></a><span>        </span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-var">Parser</span></a><span> </span><a href="#local-6989586621679161129"><span class="hs-identifier hs-var">step</span></a><span> </span><a href="#local-6989586621679161127"><span class="hs-identifier hs-var">initial</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679161130"><span class="hs-identifier hs-var">fmap2</span></a><span> </span><a href="#local-6989586621679161125"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679161128"><span class="hs-identifier hs-var">extract</span></a><span class="hs-special">)</span><span>
</span><a name="line-220"></a><span>
</span><a name="line-221"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-222"></a><span>
</span><a name="line-223"></a><span>        </span><a name="local-6989586621679161129"><a href="#local-6989586621679161129"><span class="hs-identifier">step</span></a></a><span> </span><a name="local-6989586621679161131"><a href="#local-6989586621679161131"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621679161132"><a href="#local-6989586621679161132"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679161130"><span class="hs-identifier hs-var">fmap2</span></a><span> </span><a href="#local-6989586621679161125"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679161126"><span class="hs-identifier hs-var">step1</span></a><span> </span><a href="#local-6989586621679161131"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621679161132"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-224"></a><span>        </span><a name="local-6989586621679161130"><a href="#local-6989586621679161130"><span class="hs-identifier">fmap2</span></a></a><span> </span><a name="local-6989586621679161133"><a href="#local-6989586621679161133"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="#local-6989586621679161133"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span>
</span><a name="line-225"></a><span>
</span><a name="line-226"></a><span class="hs-comment">-- This is the dual of stream &quot;yield&quot;.</span><span>
</span><a name="line-227"></a><span class="hs-comment">--</span><span>
</span><a name="line-228"></a><span class="hs-comment">-- | A parser that always yields a pure value without consuming any input.</span><span>
</span><a name="line-229"></a><span class="hs-comment">--</span><span>
</span><a name="line-230"></a><span class="hs-comment">-- /Internal/</span><span>
</span><a name="line-231"></a><span class="hs-comment">--</span><span>
</span><a name="line-232"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">yield</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-233"></a><span class="hs-identifier">yield</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679161169"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679161170"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-type">Parser</span></a><span> </span><a href="#local-6989586621679161169"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679161171"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679161170"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-234"></a><a name="yield"><a href="Streamly.Internal.Data.Parser.Types.html#yield"><span class="hs-identifier">yield</span></a></a><span> </span><a name="local-6989586621679161172"><a href="#local-6989586621679161172"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-var">Parser</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><span class="hs-number">1</span><span> </span><a href="#local-6989586621679161172"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- step</span><span>
</span><a name="line-235"></a><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>                  </span><span class="hs-comment">-- initial</span><span>
</span><a name="line-236"></a><span>                 </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679161172"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>             </span><span class="hs-comment">-- extract</span><span>
</span><a name="line-237"></a><span>
</span><a name="line-238"></a><span class="hs-comment">-- This is the dual of stream &quot;yieldM&quot;.</span><span>
</span><a name="line-239"></a><span class="hs-comment">--</span><span>
</span><a name="line-240"></a><span class="hs-comment">-- | A parser that always yields the result of an effectful action without</span><span>
</span><a name="line-241"></a><span class="hs-comment">-- consuming any input.</span><span>
</span><a name="line-242"></a><span class="hs-comment">--</span><span>
</span><a name="line-243"></a><span class="hs-comment">-- /Internal/</span><span>
</span><a name="line-244"></a><span class="hs-comment">--</span><span>
</span><a name="line-245"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">yieldM</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-246"></a><span class="hs-identifier">yieldM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679161166"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679161166"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679161167"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-type">Parser</span></a><span> </span><a href="#local-6989586621679161166"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679161168"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679161167"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-247"></a><a name="yieldM"><a href="Streamly.Internal.Data.Parser.Types.html#yieldM"><span class="hs-identifier">yieldM</span></a></a><span> </span><a name="local-6989586621679161173"><a href="#local-6989586621679161173"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-var">Parser</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><span class="hs-number">1</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679161173"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- step</span><span>
</span><a name="line-248"></a><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>              </span><span class="hs-comment">-- initial</span><span>
</span><a name="line-249"></a><span>                  </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679161173"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>              </span><span class="hs-comment">-- extract</span><span>
</span><a name="line-250"></a><span>
</span><a name="line-251"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-252"></a><span class="hs-comment">-- Sequential applicative</span><span>
</span><a name="line-253"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-254"></a><span>
</span><a name="line-255"></a><span class="hs-pragma">{-# ANN</span><span> </span><span class="hs-pragma">type</span><span> </span><span class="hs-pragma">SeqParseState</span><span> </span><span class="hs-pragma">Fuse</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-256"></a><span class="hs-keyword">data</span><span> </span><a name="SeqParseState"><a href="Streamly.Internal.Data.Parser.Types.html#SeqParseState"><span class="hs-identifier">SeqParseState</span></a></a><span> </span><a name="local-6989586621679161071"><a href="#local-6989586621679161071"><span class="hs-identifier">sl</span></a></a><span> </span><a name="local-6989586621679161072"><a href="#local-6989586621679161072"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679161073"><a href="#local-6989586621679161073"><span class="hs-identifier">sr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="SeqParseL"><a href="Streamly.Internal.Data.Parser.Types.html#SeqParseL"><span class="hs-identifier">SeqParseL</span></a></a><span> </span><a href="#local-6989586621679161071"><span class="hs-identifier hs-type">sl</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="SeqParseR"><a href="Streamly.Internal.Data.Parser.Types.html#SeqParseR"><span class="hs-identifier">SeqParseR</span></a></a><span> </span><a href="#local-6989586621679161072"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-6989586621679161073"><span class="hs-identifier hs-type">sr</span></a><span>
</span><a name="line-257"></a><span>
</span><a name="line-258"></a><span class="hs-comment">-- Note: this implementation of splitWith is fast because of stream fusion but</span><span>
</span><a name="line-259"></a><span class="hs-comment">-- has quadratic time complexity, because each composition adds a new branch</span><span>
</span><a name="line-260"></a><span class="hs-comment">-- that each subsequent parse's input element has to go through, therefore, it</span><span>
</span><a name="line-261"></a><span class="hs-comment">-- cannot scale to a large number of compositions. After around 100</span><span>
</span><a name="line-262"></a><span class="hs-comment">-- compositions the performance starts dipping rapidly beyond a CPS style</span><span>
</span><a name="line-263"></a><span class="hs-comment">-- unfused implementation.</span><span>
</span><a name="line-264"></a><span class="hs-comment">--</span><span>
</span><a name="line-265"></a><span class="hs-comment">-- | Sequential application. Apply two parsers sequentially to an input stream.</span><span>
</span><a name="line-266"></a><span class="hs-comment">-- The input is provided to the first parser, when it is done the remaining</span><span>
</span><a name="line-267"></a><span class="hs-comment">-- input is provided to the second parser. If both the parsers succeed their</span><span>
</span><a name="line-268"></a><span class="hs-comment">-- outputs are combined using the supplied function. The operation fails if any</span><span>
</span><a name="line-269"></a><span class="hs-comment">-- of the parsers fail.</span><span>
</span><a name="line-270"></a><span class="hs-comment">--</span><span>
</span><a name="line-271"></a><span class="hs-comment">-- This undoes an &quot;append&quot; of two streams, it splits the streams using two</span><span>
</span><a name="line-272"></a><span class="hs-comment">-- parsers and zips the results.</span><span>
</span><a name="line-273"></a><span class="hs-comment">--</span><span>
</span><a name="line-274"></a><span class="hs-comment">-- This implementation is strict in the second argument, therefore, the</span><span>
</span><a name="line-275"></a><span class="hs-comment">-- following will fail:</span><span>
</span><a name="line-276"></a><span class="hs-comment">--</span><span>
</span><a name="line-277"></a><span class="hs-comment">-- &gt;&gt;&gt; S.parse (PR.satisfy (&gt; 0) *&gt; undefined) $ S.fromList [1]</span><span>
</span><a name="line-278"></a><span class="hs-comment">--</span><span>
</span><a name="line-279"></a><span class="hs-comment">-- /Internal/</span><span>
</span><a name="line-280"></a><span class="hs-comment">--</span><span>
</span><a name="line-281"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">splitWith</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-282"></a><span class="hs-identifier">splitWith</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679161161"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-283"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679161162"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679161163"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679161164"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-type">Parser</span></a><span> </span><a href="#local-6989586621679161161"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679161165"><span class="hs-identifier hs-type">x</span></a><span> </span><a href="#local-6989586621679161162"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-type">Parser</span></a><span> </span><a href="#local-6989586621679161161"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679161165"><span class="hs-identifier hs-type">x</span></a><span> </span><a href="#local-6989586621679161163"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-type">Parser</span></a><span> </span><a href="#local-6989586621679161161"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679161165"><span class="hs-identifier hs-type">x</span></a><span> </span><a href="#local-6989586621679161164"><span class="hs-identifier hs-type">c</span></a><span>
</span><a name="line-284"></a><a name="splitWith"><a href="Streamly.Internal.Data.Parser.Types.html#splitWith"><span class="hs-identifier">splitWith</span></a></a><span> </span><a name="local-6989586621679161174"><a href="#local-6989586621679161174"><span class="hs-identifier">func</span></a></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-var">Parser</span></a><span> </span><a name="local-6989586621679161175"><a href="#local-6989586621679161175"><span class="hs-identifier">stepL</span></a></a><span> </span><a name="local-6989586621679161176"><a href="#local-6989586621679161176"><span class="hs-identifier">initialL</span></a></a><span> </span><a name="local-6989586621679161177"><a href="#local-6989586621679161177"><span class="hs-identifier">extractL</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-285"></a><span>               </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-var">Parser</span></a><span> </span><a name="local-6989586621679161178"><a href="#local-6989586621679161178"><span class="hs-identifier">stepR</span></a></a><span> </span><a name="local-6989586621679161179"><a href="#local-6989586621679161179"><span class="hs-identifier">initialR</span></a></a><span> </span><a name="local-6989586621679161180"><a href="#local-6989586621679161180"><span class="hs-identifier">extractR</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-286"></a><span>    </span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-var">Parser</span></a><span> </span><a href="#local-6989586621679161182"><span class="hs-identifier hs-var">step</span></a><span> </span><a href="#local-6989586621679161181"><span class="hs-identifier hs-var">initial</span></a><span> </span><a href="#local-6989586621679161183"><span class="hs-identifier hs-var">extract</span></a><span>
</span><a name="line-287"></a><span>
</span><a name="line-288"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-289"></a><span>
</span><a name="line-290"></a><span>    </span><a name="local-6989586621679161181"><a href="#local-6989586621679161181"><span class="hs-identifier">initial</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#SeqParseL"><span class="hs-identifier hs-var">SeqParseL</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679161176"><span class="hs-identifier hs-var">initialL</span></a><span>
</span><a name="line-291"></a><span>
</span><a name="line-292"></a><span>    </span><span class="hs-comment">-- Note: For the composed parse to terminate, the left parser has to be</span><span>
</span><a name="line-293"></a><span>    </span><span class="hs-comment">-- a terminating parser returning a Stop at some point.</span><span>
</span><a name="line-294"></a><span>    </span><a name="local-6989586621679161182"><a href="#local-6989586621679161182"><span class="hs-identifier">step</span></a></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#SeqParseL"><span class="hs-identifier hs-var">SeqParseL</span></a><span> </span><a name="local-6989586621679161184"><a href="#local-6989586621679161184"><span class="hs-identifier">st</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679161185"><a href="#local-6989586621679161185"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-295"></a><span>        </span><a name="local-6989586621679161186"><a href="#local-6989586621679161186"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679161175"><span class="hs-identifier hs-var">stepL</span></a><span> </span><a href="#local-6989586621679161184"><span class="hs-identifier hs-var">st</span></a><span> </span><a href="#local-6989586621679161185"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-296"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679161186"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-297"></a><span>            </span><span class="hs-comment">-- Note: this leads to buffering even if we are not in an</span><span>
</span><a name="line-298"></a><span>            </span><span class="hs-comment">-- Alternative composition.</span><span>
</span><a name="line-299"></a><span>            </span><a href="Streamly.Internal.Data.Parser.Types.html#Yield"><span class="hs-identifier hs-var">Yield</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679161187"><a href="#local-6989586621679161187"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Skip"><span class="hs-identifier hs-var">Skip</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#SeqParseL"><span class="hs-identifier hs-var">SeqParseL</span></a><span> </span><a href="#local-6989586621679161187"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-300"></a><span>            </span><a href="Streamly.Internal.Data.Parser.Types.html#Skip"><span class="hs-identifier hs-var">Skip</span></a><span> </span><a name="local-6989586621679161188"><a href="#local-6989586621679161188"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679161189"><a href="#local-6989586621679161189"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Skip"><span class="hs-identifier hs-var">Skip</span></a><span> </span><a href="#local-6989586621679161188"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#SeqParseL"><span class="hs-identifier hs-var">SeqParseL</span></a><span> </span><a href="#local-6989586621679161189"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-301"></a><span>            </span><a href="Streamly.Internal.Data.Parser.Types.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a name="local-6989586621679161190"><a href="#local-6989586621679161190"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679161191"><a href="#local-6989586621679161191"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Skip"><span class="hs-identifier hs-var">Skip</span></a><span> </span><a href="#local-6989586621679161190"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#SeqParseR"><span class="hs-identifier hs-var">SeqParseR</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679161174"><span class="hs-identifier hs-var">func</span></a><span> </span><a href="#local-6989586621679161191"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679161179"><span class="hs-identifier hs-var">initialR</span></a><span class="hs-special">)</span><span>
</span><a name="line-302"></a><span>            </span><a href="Streamly.Internal.Data.Parser.Types.html#Error"><span class="hs-identifier hs-var">Error</span></a><span> </span><a name="local-6989586621679161192"><a href="#local-6989586621679161192"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Error"><span class="hs-identifier hs-var">Error</span></a><span> </span><a href="#local-6989586621679161192"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-303"></a><span>
</span><a name="line-304"></a><span>    </span><span class="hs-identifier">step</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#SeqParseR"><span class="hs-identifier hs-var">SeqParseR</span></a><span> </span><a name="local-6989586621679161193"><a href="#local-6989586621679161193"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679161194"><a href="#local-6989586621679161194"><span class="hs-identifier">st</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679161195"><a href="#local-6989586621679161195"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-305"></a><span>        </span><a name="local-6989586621679161196"><a href="#local-6989586621679161196"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679161178"><span class="hs-identifier hs-var">stepR</span></a><span> </span><a href="#local-6989586621679161194"><span class="hs-identifier hs-var">st</span></a><span> </span><a href="#local-6989586621679161195"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-306"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679161196"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-307"></a><span>            </span><a href="Streamly.Internal.Data.Parser.Types.html#Yield"><span class="hs-identifier hs-var">Yield</span></a><span> </span><a name="local-6989586621679161197"><a href="#local-6989586621679161197"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679161198"><a href="#local-6989586621679161198"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Yield"><span class="hs-identifier hs-var">Yield</span></a><span> </span><a href="#local-6989586621679161197"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#SeqParseR"><span class="hs-identifier hs-var">SeqParseR</span></a><span> </span><a href="#local-6989586621679161193"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679161198"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-308"></a><span>            </span><a href="Streamly.Internal.Data.Parser.Types.html#Skip"><span class="hs-identifier hs-var">Skip</span></a><span> </span><a name="local-6989586621679161199"><a href="#local-6989586621679161199"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679161200"><a href="#local-6989586621679161200"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Skip"><span class="hs-identifier hs-var">Skip</span></a><span> </span><a href="#local-6989586621679161199"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#SeqParseR"><span class="hs-identifier hs-var">SeqParseR</span></a><span> </span><a href="#local-6989586621679161193"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679161200"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-309"></a><span>            </span><a href="Streamly.Internal.Data.Parser.Types.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a name="local-6989586621679161201"><a href="#local-6989586621679161201"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679161202"><a href="#local-6989586621679161202"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a href="#local-6989586621679161201"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679161193"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679161202"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-310"></a><span>            </span><a href="Streamly.Internal.Data.Parser.Types.html#Error"><span class="hs-identifier hs-var">Error</span></a><span> </span><a name="local-6989586621679161203"><a href="#local-6989586621679161203"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Error"><span class="hs-identifier hs-var">Error</span></a><span> </span><a href="#local-6989586621679161203"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-311"></a><span>
</span><a name="line-312"></a><span>    </span><a name="local-6989586621679161183"><a href="#local-6989586621679161183"><span class="hs-identifier">extract</span></a></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#SeqParseR"><span class="hs-identifier hs-var">SeqParseR</span></a><span> </span><a name="local-6989586621679161204"><a href="#local-6989586621679161204"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679161205"><a href="#local-6989586621679161205"><span class="hs-identifier">sR</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="#local-6989586621679161204"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679161180"><span class="hs-identifier hs-var">extractR</span></a><span> </span><a href="#local-6989586621679161205"><span class="hs-identifier hs-var">sR</span></a><span class="hs-special">)</span><span>
</span><a name="line-313"></a><span>    </span><span class="hs-identifier">extract</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#SeqParseL"><span class="hs-identifier hs-var">SeqParseL</span></a><span> </span><a name="local-6989586621679161206"><a href="#local-6989586621679161206"><span class="hs-identifier">sL</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-314"></a><span>        </span><a name="local-6989586621679161207"><a href="#local-6989586621679161207"><span class="hs-identifier">rL</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679161177"><span class="hs-identifier hs-var">extractL</span></a><span> </span><a href="#local-6989586621679161206"><span class="hs-identifier hs-var">sL</span></a><span>
</span><a name="line-315"></a><span>        </span><a name="local-6989586621679161208"><a href="#local-6989586621679161208"><span class="hs-identifier">sR</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679161179"><span class="hs-identifier hs-var">initialR</span></a><span>
</span><a name="line-316"></a><span>        </span><a name="local-6989586621679161209"><a href="#local-6989586621679161209"><span class="hs-identifier">rR</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679161180"><span class="hs-identifier hs-var">extractR</span></a><span> </span><a href="#local-6989586621679161208"><span class="hs-identifier hs-var">sR</span></a><span>
</span><a name="line-317"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679161174"><span class="hs-identifier hs-var">func</span></a><span> </span><a href="#local-6989586621679161207"><span class="hs-identifier hs-var">rL</span></a><span> </span><a href="#local-6989586621679161209"><span class="hs-identifier hs-var">rR</span></a><span>
</span><a name="line-318"></a><span>
</span><a name="line-319"></a><span class="hs-comment">-- | 'Applicative' form of 'splitWith'.</span><span>
</span><a name="line-320"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679161121"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-type">Parser</span></a><span> </span><a href="#local-6989586621679161121"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679161122"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-321"></a><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">pure</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-322"></a><span>    </span><a name="local-3458764513820541680"><span class="hs-identifier">pure</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#yield"><span class="hs-identifier hs-var">yield</span></a><span>
</span><a name="line-323"></a><span>
</span><a name="line-324"></a><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">(</span><span class="hs-pragma">&lt;*&gt;</span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-325"></a><span>    </span><span class="hs-special">(</span><a name="local-3458764513820541679"><span class="hs-operator">&lt;*&gt;</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#splitWith"><span class="hs-identifier hs-var">splitWith</span></a><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-326"></a><span>
</span><a name="line-327"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-328"></a><span class="hs-comment">-- Sequential Alternative</span><span>
</span><a name="line-329"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-330"></a><span>
</span><a name="line-331"></a><span class="hs-pragma">{-# ANN</span><span> </span><span class="hs-pragma">type</span><span> </span><span class="hs-pragma">AltParseState</span><span> </span><span class="hs-pragma">Fuse</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-332"></a><span class="hs-keyword">data</span><span> </span><a name="AltParseState"><a href="Streamly.Internal.Data.Parser.Types.html#AltParseState"><span class="hs-identifier">AltParseState</span></a></a><span> </span><a name="local-6989586621679161069"><a href="#local-6989586621679161069"><span class="hs-identifier">sl</span></a></a><span> </span><a name="local-6989586621679161070"><a href="#local-6989586621679161070"><span class="hs-identifier">sr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="AltParseL"><a href="Streamly.Internal.Data.Parser.Types.html#AltParseL"><span class="hs-identifier">AltParseL</span></a></a><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><a href="#local-6989586621679161069"><span class="hs-identifier hs-type">sl</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="AltParseR"><a href="Streamly.Internal.Data.Parser.Types.html#AltParseR"><span class="hs-identifier">AltParseR</span></a></a><span> </span><a href="#local-6989586621679161070"><span class="hs-identifier hs-type">sr</span></a><span>
</span><a name="line-333"></a><span>
</span><a name="line-334"></a><span class="hs-comment">-- Note: this implementation of alt is fast because of stream fusion but has</span><span>
</span><a name="line-335"></a><span class="hs-comment">-- quadratic time complexity, because each composition adds a new branch that</span><span>
</span><a name="line-336"></a><span class="hs-comment">-- each subsequent alternative's input element has to go through, therefore, it</span><span>
</span><a name="line-337"></a><span class="hs-comment">-- cannot scale to a large number of compositions</span><span>
</span><a name="line-338"></a><span class="hs-comment">--</span><span>
</span><a name="line-339"></a><span class="hs-comment">-- | Sequential alternative. Apply the input to the first parser and return the</span><span>
</span><a name="line-340"></a><span class="hs-comment">-- result if the parser succeeds. If the first parser fails then backtrack and</span><span>
</span><a name="line-341"></a><span class="hs-comment">-- apply the same input to the second parser and return the result.</span><span>
</span><a name="line-342"></a><span class="hs-comment">--</span><span>
</span><a name="line-343"></a><span class="hs-comment">-- Note: This implementation is not lazy in the second argument. The following</span><span>
</span><a name="line-344"></a><span class="hs-comment">-- will fail:</span><span>
</span><a name="line-345"></a><span class="hs-comment">--</span><span>
</span><a name="line-346"></a><span class="hs-comment">-- &gt;&gt;&gt; S.parse (PR.satisfy (&gt; 0) `PR.alt` undefined) $ S.fromList [1..10]</span><span>
</span><a name="line-347"></a><span class="hs-comment">--</span><span>
</span><a name="line-348"></a><span class="hs-comment">-- /Internal/</span><span>
</span><a name="line-349"></a><span class="hs-comment">--</span><span>
</span><a name="line-350"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">alt</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-351"></a><span class="hs-identifier">alt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679161158"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-type">Parser</span></a><span> </span><a href="#local-6989586621679161158"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679161159"><span class="hs-identifier hs-type">x</span></a><span> </span><a href="#local-6989586621679161160"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-type">Parser</span></a><span> </span><a href="#local-6989586621679161158"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679161159"><span class="hs-identifier hs-type">x</span></a><span> </span><a href="#local-6989586621679161160"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-type">Parser</span></a><span> </span><a href="#local-6989586621679161158"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679161159"><span class="hs-identifier hs-type">x</span></a><span> </span><a href="#local-6989586621679161160"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-352"></a><a name="alt"><a href="Streamly.Internal.Data.Parser.Types.html#alt"><span class="hs-identifier">alt</span></a></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-var">Parser</span></a><span> </span><a name="local-6989586621679161210"><a href="#local-6989586621679161210"><span class="hs-identifier">stepL</span></a></a><span> </span><a name="local-6989586621679161211"><a href="#local-6989586621679161211"><span class="hs-identifier">initialL</span></a></a><span> </span><a name="local-6989586621679161212"><a href="#local-6989586621679161212"><span class="hs-identifier">extractL</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-var">Parser</span></a><span> </span><a name="local-6989586621679161213"><a href="#local-6989586621679161213"><span class="hs-identifier">stepR</span></a></a><span> </span><a name="local-6989586621679161214"><a href="#local-6989586621679161214"><span class="hs-identifier">initialR</span></a></a><span> </span><a name="local-6989586621679161215"><a href="#local-6989586621679161215"><span class="hs-identifier">extractR</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-353"></a><span>    </span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-var">Parser</span></a><span> </span><a href="#local-6989586621679161217"><span class="hs-identifier hs-var">step</span></a><span> </span><a href="#local-6989586621679161216"><span class="hs-identifier hs-var">initial</span></a><span> </span><a href="#local-6989586621679161218"><span class="hs-identifier hs-var">extract</span></a><span>
</span><a name="line-354"></a><span>
</span><a name="line-355"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-356"></a><span>
</span><a name="line-357"></a><span>    </span><a name="local-6989586621679161216"><a href="#local-6989586621679161216"><span class="hs-identifier">initial</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#AltParseL"><span class="hs-identifier hs-var">AltParseL</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679161211"><span class="hs-identifier hs-var">initialL</span></a><span>
</span><a name="line-358"></a><span>
</span><a name="line-359"></a><span>    </span><span class="hs-comment">-- Once a parser yields at least one value it cannot fail.  This</span><span>
</span><a name="line-360"></a><span>    </span><span class="hs-comment">-- restriction helps us make backtracking more efficient, as we do not need</span><span>
</span><a name="line-361"></a><span>    </span><span class="hs-comment">-- to keep the consumed items buffered after a yield. Note that we do not</span><span>
</span><a name="line-362"></a><span>    </span><span class="hs-comment">-- enforce this and if a misbehaving parser does not honor this then we can</span><span>
</span><a name="line-363"></a><span>    </span><span class="hs-comment">-- get unexpected results.</span><span>
</span><a name="line-364"></a><span>    </span><a name="local-6989586621679161217"><a href="#local-6989586621679161217"><span class="hs-identifier">step</span></a></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#AltParseL"><span class="hs-identifier hs-var">AltParseL</span></a><span> </span><a name="local-6989586621679161219"><a href="#local-6989586621679161219"><span class="hs-identifier">cnt</span></a></a><span> </span><a name="local-6989586621679161220"><a href="#local-6989586621679161220"><span class="hs-identifier">st</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679161221"><a href="#local-6989586621679161221"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-365"></a><span>        </span><a name="local-6989586621679161222"><a href="#local-6989586621679161222"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679161210"><span class="hs-identifier hs-var">stepL</span></a><span> </span><a href="#local-6989586621679161220"><span class="hs-identifier hs-var">st</span></a><span> </span><a href="#local-6989586621679161221"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-366"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679161222"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-367"></a><span>            </span><a href="Streamly.Internal.Data.Parser.Types.html#Yield"><span class="hs-identifier hs-var">Yield</span></a><span> </span><a name="local-6989586621679161223"><a href="#local-6989586621679161223"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679161224"><a href="#local-6989586621679161224"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Yield"><span class="hs-identifier hs-var">Yield</span></a><span> </span><a href="#local-6989586621679161223"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#AltParseL"><span class="hs-identifier hs-var">AltParseL</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621679161224"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-368"></a><span>            </span><a href="Streamly.Internal.Data.Parser.Types.html#Skip"><span class="hs-identifier hs-var">Skip</span></a><span> </span><a name="local-6989586621679161225"><a href="#local-6989586621679161225"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679161226"><a href="#local-6989586621679161226"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-369"></a><span>                </span><span class="hs-identifier hs-var">assert</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679161219"><span class="hs-identifier hs-var">cnt</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679161225"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-370"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Skip"><span class="hs-identifier hs-var">Skip</span></a><span> </span><a href="#local-6989586621679161225"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#AltParseL"><span class="hs-identifier hs-var">AltParseL</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679161219"><span class="hs-identifier hs-var">cnt</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679161225"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679161226"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-371"></a><span>            </span><a href="Streamly.Internal.Data.Parser.Types.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a name="local-6989586621679161227"><a href="#local-6989586621679161227"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679161228"><a href="#local-6989586621679161228"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a href="#local-6989586621679161227"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679161228"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-372"></a><span>            </span><a href="Streamly.Internal.Data.Parser.Types.html#Error"><span class="hs-identifier hs-var">Error</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-373"></a><span>                </span><a name="local-6989586621679161229"><a href="#local-6989586621679161229"><span class="hs-identifier">rR</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679161214"><span class="hs-identifier hs-var">initialR</span></a><span>
</span><a name="line-374"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Skip"><span class="hs-identifier hs-var">Skip</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679161219"><span class="hs-identifier hs-var">cnt</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#AltParseR"><span class="hs-identifier hs-var">AltParseR</span></a><span> </span><a href="#local-6989586621679161229"><span class="hs-identifier hs-var">rR</span></a><span class="hs-special">)</span><span>
</span><a name="line-375"></a><span>
</span><a name="line-376"></a><span>    </span><span class="hs-identifier">step</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#AltParseR"><span class="hs-identifier hs-var">AltParseR</span></a><span> </span><a name="local-6989586621679161230"><a href="#local-6989586621679161230"><span class="hs-identifier">st</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679161231"><a href="#local-6989586621679161231"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-377"></a><span>        </span><a name="local-6989586621679161232"><a href="#local-6989586621679161232"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679161213"><span class="hs-identifier hs-var">stepR</span></a><span> </span><a href="#local-6989586621679161230"><span class="hs-identifier hs-var">st</span></a><span> </span><a href="#local-6989586621679161231"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-378"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679161232"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-379"></a><span>            </span><a href="Streamly.Internal.Data.Parser.Types.html#Yield"><span class="hs-identifier hs-var">Yield</span></a><span> </span><a name="local-6989586621679161233"><a href="#local-6989586621679161233"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679161234"><a href="#local-6989586621679161234"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Yield"><span class="hs-identifier hs-var">Yield</span></a><span> </span><a href="#local-6989586621679161233"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#AltParseR"><span class="hs-identifier hs-var">AltParseR</span></a><span> </span><a href="#local-6989586621679161234"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-380"></a><span>            </span><a href="Streamly.Internal.Data.Parser.Types.html#Skip"><span class="hs-identifier hs-var">Skip</span></a><span> </span><a name="local-6989586621679161235"><a href="#local-6989586621679161235"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679161236"><a href="#local-6989586621679161236"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Skip"><span class="hs-identifier hs-var">Skip</span></a><span> </span><a href="#local-6989586621679161235"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#AltParseR"><span class="hs-identifier hs-var">AltParseR</span></a><span> </span><a href="#local-6989586621679161236"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-381"></a><span>            </span><a href="Streamly.Internal.Data.Parser.Types.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a name="local-6989586621679161237"><a href="#local-6989586621679161237"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679161238"><a href="#local-6989586621679161238"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a href="#local-6989586621679161237"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679161238"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-382"></a><span>            </span><a href="Streamly.Internal.Data.Parser.Types.html#Error"><span class="hs-identifier hs-var">Error</span></a><span> </span><a name="local-6989586621679161239"><a href="#local-6989586621679161239"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Error"><span class="hs-identifier hs-var">Error</span></a><span> </span><a href="#local-6989586621679161239"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-383"></a><span>
</span><a name="line-384"></a><span>    </span><a name="local-6989586621679161218"><a href="#local-6989586621679161218"><span class="hs-identifier">extract</span></a></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#AltParseR"><span class="hs-identifier hs-var">AltParseR</span></a><span> </span><a name="local-6989586621679161240"><a href="#local-6989586621679161240"><span class="hs-identifier">sR</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679161215"><span class="hs-identifier hs-var">extractR</span></a><span> </span><a href="#local-6989586621679161240"><span class="hs-identifier hs-var">sR</span></a><span>
</span><a name="line-385"></a><span>    </span><span class="hs-identifier">extract</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#AltParseL"><span class="hs-identifier hs-var">AltParseL</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679161241"><a href="#local-6989586621679161241"><span class="hs-identifier">sL</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679161212"><span class="hs-identifier hs-var">extractL</span></a><span> </span><a href="#local-6989586621679161241"><span class="hs-identifier hs-var">sL</span></a><span>
</span><a name="line-386"></a><span>
</span><a name="line-387"></a><span class="hs-comment">-- | See documentation of 'Streamly.Internal.Data.Parser.many'.</span><span>
</span><a name="line-388"></a><span class="hs-comment">--</span><span>
</span><a name="line-389"></a><span class="hs-comment">-- /Internal/</span><span>
</span><a name="line-390"></a><span class="hs-comment">--</span><span>
</span><a name="line-391"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">splitMany</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-392"></a><span class="hs-identifier">splitMany</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadCatch</span><span> </span><a href="#local-6989586621679161154"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-type">Fold</span></a><span> </span><a href="#local-6989586621679161154"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679161155"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621679161156"><span class="hs-identifier hs-type">c</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-type">Parser</span></a><span> </span><a href="#local-6989586621679161154"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679161157"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679161155"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-type">Parser</span></a><span> </span><a href="#local-6989586621679161154"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679161157"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679161156"><span class="hs-identifier hs-type">c</span></a><span>
</span><a name="line-393"></a><a name="splitMany"><a href="Streamly.Internal.Data.Parser.Types.html#splitMany"><span class="hs-identifier">splitMany</span></a></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-var">Fold</span></a><span> </span><a name="local-6989586621679161242"><a href="#local-6989586621679161242"><span class="hs-identifier">fstep</span></a></a><span> </span><a name="local-6989586621679161243"><a href="#local-6989586621679161243"><span class="hs-identifier">finitial</span></a></a><span> </span><a name="local-6989586621679161244"><a href="#local-6989586621679161244"><span class="hs-identifier">fextract</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-var">Parser</span></a><span> </span><a name="local-6989586621679161245"><a href="#local-6989586621679161245"><span class="hs-identifier">step1</span></a></a><span> </span><a name="local-6989586621679161246"><a href="#local-6989586621679161246"><span class="hs-identifier">initial1</span></a></a><span> </span><a name="local-6989586621679161247"><a href="#local-6989586621679161247"><span class="hs-identifier">extract1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-394"></a><span>    </span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-var">Parser</span></a><span> </span><a href="#local-6989586621679161249"><span class="hs-identifier hs-var">step</span></a><span> </span><a href="#local-6989586621679161248"><span class="hs-identifier hs-var">initial</span></a><span> </span><a href="#local-6989586621679161250"><span class="hs-identifier hs-var">extract</span></a><span>
</span><a name="line-395"></a><span>
</span><a name="line-396"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-397"></a><span>
</span><a name="line-398"></a><span>    </span><a name="local-6989586621679161248"><a href="#local-6989586621679161248"><span class="hs-identifier">initial</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-399"></a><span>        </span><a name="local-6989586621679161251"><a href="#local-6989586621679161251"><span class="hs-identifier">ps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679161246"><span class="hs-identifier hs-var">initial1</span></a><span> </span><span class="hs-comment">-- parse state</span><span>
</span><a name="line-400"></a><span>        </span><a name="local-6989586621679161252"><a href="#local-6989586621679161252"><span class="hs-identifier">fs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679161243"><span class="hs-identifier hs-var">finitial</span></a><span> </span><span class="hs-comment">-- fold state</span><span>
</span><a name="line-401"></a><span>        </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Strict.html#Tuple3%27"><span class="hs-identifier hs-var">Tuple3'</span></a><span> </span><a href="#local-6989586621679161251"><span class="hs-identifier hs-var">ps</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621679161252"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span>
</span><a name="line-402"></a><span>
</span><a name="line-403"></a><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">step</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-404"></a><span>    </span><a name="local-6989586621679161249"><a href="#local-6989586621679161249"><span class="hs-identifier">step</span></a></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Strict.html#Tuple3%27"><span class="hs-identifier hs-var">Tuple3'</span></a><span> </span><a name="local-6989586621679161253"><a href="#local-6989586621679161253"><span class="hs-identifier">st</span></a></a><span> </span><a name="local-6989586621679161254"><a href="#local-6989586621679161254"><span class="hs-identifier">cnt</span></a></a><span> </span><a name="local-6989586621679161255"><a href="#local-6989586621679161255"><span class="hs-identifier">fs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679161256"><a href="#local-6989586621679161256"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-405"></a><span>        </span><a name="local-6989586621679161257"><a href="#local-6989586621679161257"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679161245"><span class="hs-identifier hs-var">step1</span></a><span> </span><a href="#local-6989586621679161253"><span class="hs-identifier hs-var">st</span></a><span> </span><a href="#local-6989586621679161256"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-406"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679161258"><a href="#local-6989586621679161258"><span class="hs-identifier">cnt1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679161254"><span class="hs-identifier hs-var">cnt</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-407"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679161257"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-408"></a><span>            </span><a href="Streamly.Internal.Data.Parser.Types.html#Yield"><span class="hs-identifier hs-var">Yield</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679161259"><a href="#local-6989586621679161259"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Skip"><span class="hs-identifier hs-var">Skip</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Strict.html#Tuple3%27"><span class="hs-identifier hs-var">Tuple3'</span></a><span> </span><a href="#local-6989586621679161259"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621679161258"><span class="hs-identifier hs-var">cnt1</span></a><span> </span><a href="#local-6989586621679161255"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span>
</span><a name="line-409"></a><span>            </span><a href="Streamly.Internal.Data.Parser.Types.html#Skip"><span class="hs-identifier hs-var">Skip</span></a><span> </span><a name="local-6989586621679161260"><a href="#local-6989586621679161260"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679161261"><a href="#local-6989586621679161261"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-410"></a><span>                </span><span class="hs-identifier hs-var">assert</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679161258"><span class="hs-identifier hs-var">cnt1</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679161260"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-411"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Skip"><span class="hs-identifier hs-var">Skip</span></a><span> </span><a href="#local-6989586621679161260"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Strict.html#Tuple3%27"><span class="hs-identifier hs-var">Tuple3'</span></a><span> </span><a href="#local-6989586621679161261"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679161258"><span class="hs-identifier hs-var">cnt1</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679161260"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679161255"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span>
</span><a name="line-412"></a><span>            </span><a href="Streamly.Internal.Data.Parser.Types.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a name="local-6989586621679161262"><a href="#local-6989586621679161262"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679161263"><a href="#local-6989586621679161263"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-413"></a><span>                </span><a name="local-6989586621679161264"><a href="#local-6989586621679161264"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679161246"><span class="hs-identifier hs-var">initial1</span></a><span>
</span><a name="line-414"></a><span>                </span><a name="local-6989586621679161265"><a href="#local-6989586621679161265"><span class="hs-identifier">fs1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679161242"><span class="hs-identifier hs-var">fstep</span></a><span> </span><a href="#local-6989586621679161255"><span class="hs-identifier hs-var">fs</span></a><span> </span><a href="#local-6989586621679161263"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-415"></a><span>                </span><span class="hs-comment">-- XXX we need to yield and backtrack here</span><span>
</span><a name="line-416"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Skip"><span class="hs-identifier hs-var">Skip</span></a><span> </span><a href="#local-6989586621679161262"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Strict.html#Tuple3%27"><span class="hs-identifier hs-var">Tuple3'</span></a><span> </span><a href="#local-6989586621679161264"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621679161265"><span class="hs-identifier hs-var">fs1</span></a><span class="hs-special">)</span><span>
</span><a name="line-417"></a><span>            </span><a href="Streamly.Internal.Data.Parser.Types.html#Error"><span class="hs-identifier hs-var">Error</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-418"></a><span>                </span><a name="local-6989586621679161266"><a href="#local-6989586621679161266"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679161244"><span class="hs-identifier hs-var">fextract</span></a><span> </span><a href="#local-6989586621679161255"><span class="hs-identifier hs-var">fs</span></a><span>
</span><a name="line-419"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a href="#local-6989586621679161258"><span class="hs-identifier hs-var">cnt1</span></a><span> </span><a href="#local-6989586621679161266"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-420"></a><span>
</span><a name="line-421"></a><span>    </span><span class="hs-comment">-- XXX The &quot;try&quot; may impact performance if this parser is used as a scan</span><span>
</span><a name="line-422"></a><span>    </span><a name="local-6989586621679161250"><a href="#local-6989586621679161250"><span class="hs-identifier">extract</span></a></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Strict.html#Tuple3%27"><span class="hs-identifier hs-var">Tuple3'</span></a><span> </span><a name="local-6989586621679161267"><a href="#local-6989586621679161267"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679161268"><a href="#local-6989586621679161268"><span class="hs-identifier">fs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-423"></a><span>        </span><a name="local-6989586621679161269"><a href="#local-6989586621679161269"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">try</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679161247"><span class="hs-identifier hs-var">extract1</span></a><span> </span><a href="#local-6989586621679161267"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-424"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679161269"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-425"></a><span>            </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#ParseError"><span class="hs-identifier hs-type">ParseError</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679161244"><span class="hs-identifier hs-var">fextract</span></a><span> </span><a href="#local-6989586621679161268"><span class="hs-identifier hs-var">fs</span></a><span>
</span><a name="line-426"></a><span>            </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679161270"><a href="#local-6989586621679161270"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679161242"><span class="hs-identifier hs-var">fstep</span></a><span> </span><a href="#local-6989586621679161268"><span class="hs-identifier hs-var">fs</span></a><span> </span><a href="#local-6989586621679161270"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="#local-6989586621679161244"><span class="hs-identifier hs-var">fextract</span></a><span>
</span><a name="line-427"></a><span>
</span><a name="line-428"></a><span class="hs-comment">-- | See documentation of 'Streamly.Internal.Data.Parser.some'.</span><span>
</span><a name="line-429"></a><span class="hs-comment">--</span><span>
</span><a name="line-430"></a><span class="hs-comment">-- /Internal/</span><span>
</span><a name="line-431"></a><span class="hs-comment">--</span><span>
</span><a name="line-432"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">splitSome</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-433"></a><span class="hs-identifier">splitSome</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadCatch</span><span> </span><a href="#local-6989586621679161150"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-type">Fold</span></a><span> </span><a href="#local-6989586621679161150"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679161151"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621679161152"><span class="hs-identifier hs-type">c</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-type">Parser</span></a><span> </span><a href="#local-6989586621679161150"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679161153"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679161151"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-type">Parser</span></a><span> </span><a href="#local-6989586621679161150"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679161153"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679161152"><span class="hs-identifier hs-type">c</span></a><span>
</span><a name="line-434"></a><a name="splitSome"><a href="Streamly.Internal.Data.Parser.Types.html#splitSome"><span class="hs-identifier">splitSome</span></a></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Fold.Types.html#Fold"><span class="hs-identifier hs-var">Fold</span></a><span> </span><a name="local-6989586621679161271"><a href="#local-6989586621679161271"><span class="hs-identifier">fstep</span></a></a><span> </span><a name="local-6989586621679161272"><a href="#local-6989586621679161272"><span class="hs-identifier">finitial</span></a></a><span> </span><a name="local-6989586621679161273"><a href="#local-6989586621679161273"><span class="hs-identifier">fextract</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-var">Parser</span></a><span> </span><a name="local-6989586621679161274"><a href="#local-6989586621679161274"><span class="hs-identifier">step1</span></a></a><span> </span><a name="local-6989586621679161275"><a href="#local-6989586621679161275"><span class="hs-identifier">initial1</span></a></a><span> </span><a name="local-6989586621679161276"><a href="#local-6989586621679161276"><span class="hs-identifier">extract1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-435"></a><span>    </span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-var">Parser</span></a><span> </span><a href="#local-6989586621679161278"><span class="hs-identifier hs-var">step</span></a><span> </span><a href="#local-6989586621679161277"><span class="hs-identifier hs-var">initial</span></a><span> </span><a href="#local-6989586621679161279"><span class="hs-identifier hs-var">extract</span></a><span>
</span><a name="line-436"></a><span>
</span><a name="line-437"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-438"></a><span>
</span><a name="line-439"></a><span>    </span><a name="local-6989586621679161277"><a href="#local-6989586621679161277"><span class="hs-identifier">initial</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-440"></a><span>        </span><a name="local-6989586621679161280"><a href="#local-6989586621679161280"><span class="hs-identifier">ps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679161275"><span class="hs-identifier hs-var">initial1</span></a><span> </span><span class="hs-comment">-- parse state</span><span>
</span><a name="line-441"></a><span>        </span><a name="local-6989586621679161281"><a href="#local-6989586621679161281"><span class="hs-identifier">fs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679161272"><span class="hs-identifier hs-var">finitial</span></a><span> </span><span class="hs-comment">-- fold state</span><span>
</span><a name="line-442"></a><span>        </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Strict.html#Tuple3%27"><span class="hs-identifier hs-var">Tuple3'</span></a><span> </span><a href="#local-6989586621679161280"><span class="hs-identifier hs-var">ps</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a href="#local-6989586621679161281"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-443"></a><span>
</span><a name="line-444"></a><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">step</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-445"></a><span>    </span><a name="local-6989586621679161278"><a href="#local-6989586621679161278"><span class="hs-identifier">step</span></a></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Strict.html#Tuple3%27"><span class="hs-identifier hs-var">Tuple3'</span></a><span> </span><a name="local-6989586621679161282"><a href="#local-6989586621679161282"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679161283"><a href="#local-6989586621679161283"><span class="hs-identifier">fs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679161284"><a href="#local-6989586621679161284"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-446"></a><span>        </span><a name="local-6989586621679161285"><a href="#local-6989586621679161285"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679161274"><span class="hs-identifier hs-var">step1</span></a><span> </span><a href="#local-6989586621679161282"><span class="hs-identifier hs-var">st</span></a><span> </span><a href="#local-6989586621679161284"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-447"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679161285"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-448"></a><span>            </span><a href="Streamly.Internal.Data.Parser.Types.html#Yield"><span class="hs-identifier hs-var">Yield</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679161286"><a href="#local-6989586621679161286"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Skip"><span class="hs-identifier hs-var">Skip</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Strict.html#Tuple3%27"><span class="hs-identifier hs-var">Tuple3'</span></a><span> </span><a href="#local-6989586621679161286"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-identifier hs-var">undefined</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a href="#local-6989586621679161283"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-449"></a><span>            </span><a href="Streamly.Internal.Data.Parser.Types.html#Skip"><span class="hs-identifier hs-var">Skip</span></a><span>  </span><a name="local-6989586621679161287"><a href="#local-6989586621679161287"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679161288"><a href="#local-6989586621679161288"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Skip"><span class="hs-identifier hs-var">Skip</span></a><span> </span><a href="#local-6989586621679161287"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Strict.html#Tuple3%27"><span class="hs-identifier hs-var">Tuple3'</span></a><span> </span><a href="#local-6989586621679161288"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-identifier hs-var">undefined</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a href="#local-6989586621679161283"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-450"></a><span>            </span><a href="Streamly.Internal.Data.Parser.Types.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a name="local-6989586621679161289"><a href="#local-6989586621679161289"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679161290"><a href="#local-6989586621679161290"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-451"></a><span>                </span><a name="local-6989586621679161291"><a href="#local-6989586621679161291"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679161275"><span class="hs-identifier hs-var">initial1</span></a><span>
</span><a name="line-452"></a><span>                </span><a name="local-6989586621679161292"><a href="#local-6989586621679161292"><span class="hs-identifier">fs1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679161271"><span class="hs-identifier hs-var">fstep</span></a><span> </span><a href="#local-6989586621679161283"><span class="hs-identifier hs-var">fs</span></a><span> </span><a href="#local-6989586621679161290"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-453"></a><span>                </span><span class="hs-comment">-- XXX this is also a yield point, we will never fail beyond</span><span>
</span><a name="line-454"></a><span>                </span><span class="hs-comment">-- this point. If we do not yield then if an error occurs after</span><span>
</span><a name="line-455"></a><span>                </span><span class="hs-comment">-- this then we will backtrack to the previous yield point</span><span>
</span><a name="line-456"></a><span>                </span><span class="hs-comment">-- instead of this point which is wrong.</span><span>
</span><a name="line-457"></a><span>                </span><span class="hs-comment">--</span><span>
</span><a name="line-458"></a><span>                </span><span class="hs-comment">-- so we need a yield with backtrack</span><span>
</span><a name="line-459"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Skip"><span class="hs-identifier hs-var">Skip</span></a><span> </span><a href="#local-6989586621679161289"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Strict.html#Tuple3%27"><span class="hs-identifier hs-var">Tuple3'</span></a><span> </span><a href="#local-6989586621679161291"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621679161292"><span class="hs-identifier hs-var">fs1</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-460"></a><span>            </span><a href="Streamly.Internal.Data.Parser.Types.html#Error"><span class="hs-identifier hs-var">Error</span></a><span> </span><a name="local-6989586621679161293"><a href="#local-6989586621679161293"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Error"><span class="hs-identifier hs-var">Error</span></a><span> </span><a href="#local-6989586621679161293"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-461"></a><span>    </span><span class="hs-identifier">step</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Strict.html#Tuple3%27"><span class="hs-identifier hs-var">Tuple3'</span></a><span> </span><a name="local-6989586621679161294"><a href="#local-6989586621679161294"><span class="hs-identifier">st</span></a></a><span> </span><a name="local-6989586621679161295"><a href="#local-6989586621679161295"><span class="hs-identifier">cnt</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679161296"><a href="#local-6989586621679161296"><span class="hs-identifier">fs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679161297"><a href="#local-6989586621679161297"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-462"></a><span>        </span><a name="local-6989586621679161298"><a href="#local-6989586621679161298"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679161274"><span class="hs-identifier hs-var">step1</span></a><span> </span><a href="#local-6989586621679161294"><span class="hs-identifier hs-var">st</span></a><span> </span><a href="#local-6989586621679161297"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-463"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679161299"><a href="#local-6989586621679161299"><span class="hs-identifier">cnt1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679161295"><span class="hs-identifier hs-var">cnt</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-464"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679161298"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-465"></a><span>            </span><a href="Streamly.Internal.Data.Parser.Types.html#Yield"><span class="hs-identifier hs-var">Yield</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679161300"><a href="#local-6989586621679161300"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Yield"><span class="hs-identifier hs-var">Yield</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Strict.html#Tuple3%27"><span class="hs-identifier hs-var">Tuple3'</span></a><span> </span><a href="#local-6989586621679161300"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621679161299"><span class="hs-identifier hs-var">cnt1</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621679161296"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-466"></a><span>            </span><a href="Streamly.Internal.Data.Parser.Types.html#Skip"><span class="hs-identifier hs-var">Skip</span></a><span> </span><a name="local-6989586621679161301"><a href="#local-6989586621679161301"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679161302"><a href="#local-6989586621679161302"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-467"></a><span>                </span><span class="hs-identifier hs-var">assert</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679161299"><span class="hs-identifier hs-var">cnt1</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679161301"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-468"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Skip"><span class="hs-identifier hs-var">Skip</span></a><span> </span><a href="#local-6989586621679161301"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Strict.html#Tuple3%27"><span class="hs-identifier hs-var">Tuple3'</span></a><span> </span><a href="#local-6989586621679161302"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679161299"><span class="hs-identifier hs-var">cnt1</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679161301"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621679161296"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-469"></a><span>            </span><a href="Streamly.Internal.Data.Parser.Types.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a name="local-6989586621679161303"><a href="#local-6989586621679161303"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679161304"><a href="#local-6989586621679161304"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-470"></a><span>                </span><a name="local-6989586621679161305"><a href="#local-6989586621679161305"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679161275"><span class="hs-identifier hs-var">initial1</span></a><span>
</span><a name="line-471"></a><span>                </span><a name="local-6989586621679161306"><a href="#local-6989586621679161306"><span class="hs-identifier">fs1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679161271"><span class="hs-identifier hs-var">fstep</span></a><span> </span><a href="#local-6989586621679161296"><span class="hs-identifier hs-var">fs</span></a><span> </span><a href="#local-6989586621679161304"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-472"></a><span>                </span><span class="hs-comment">-- XXX we need to yield here but also backtrack</span><span>
</span><a name="line-473"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Skip"><span class="hs-identifier hs-var">Skip</span></a><span> </span><a href="#local-6989586621679161303"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Strict.html#Tuple3%27"><span class="hs-identifier hs-var">Tuple3'</span></a><span> </span><a href="#local-6989586621679161305"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621679161306"><span class="hs-identifier hs-var">fs1</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-474"></a><span>            </span><a href="Streamly.Internal.Data.Parser.Types.html#Error"><span class="hs-identifier hs-var">Error</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a href="#local-6989586621679161299"><span class="hs-identifier hs-var">cnt1</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679161273"><span class="hs-identifier hs-var">fextract</span></a><span> </span><a href="#local-6989586621679161296"><span class="hs-identifier hs-var">fs</span></a><span>
</span><a name="line-475"></a><span>
</span><a name="line-476"></a><span>    </span><span class="hs-comment">-- XXX The &quot;try&quot; may impact performance if this parser is used as a scan</span><span>
</span><a name="line-477"></a><span>    </span><a name="local-6989586621679161279"><a href="#local-6989586621679161279"><span class="hs-identifier">extract</span></a></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Strict.html#Tuple3%27"><span class="hs-identifier hs-var">Tuple3'</span></a><span> </span><a name="local-6989586621679161307"><a href="#local-6989586621679161307"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679161308"><a href="#local-6989586621679161308"><span class="hs-identifier">fs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679161276"><span class="hs-identifier hs-var">extract1</span></a><span> </span><a href="#local-6989586621679161307"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="#local-6989586621679161271"><span class="hs-identifier hs-var">fstep</span></a><span> </span><a href="#local-6989586621679161308"><span class="hs-identifier hs-var">fs</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="#local-6989586621679161273"><span class="hs-identifier hs-var">fextract</span></a><span>
</span><a name="line-478"></a><span>    </span><span class="hs-identifier">extract</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Strict.html#Tuple3%27"><span class="hs-identifier hs-var">Tuple3'</span></a><span> </span><a name="local-6989586621679161309"><a href="#local-6989586621679161309"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679161310"><a href="#local-6989586621679161310"><span class="hs-identifier">fs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-479"></a><span>        </span><a name="local-6989586621679161311"><a href="#local-6989586621679161311"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">try</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679161276"><span class="hs-identifier hs-var">extract1</span></a><span> </span><a href="#local-6989586621679161309"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-480"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679161311"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-481"></a><span>            </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#ParseError"><span class="hs-identifier hs-type">ParseError</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679161273"><span class="hs-identifier hs-var">fextract</span></a><span> </span><a href="#local-6989586621679161310"><span class="hs-identifier hs-var">fs</span></a><span>
</span><a name="line-482"></a><span>            </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679161312"><a href="#local-6989586621679161312"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679161271"><span class="hs-identifier hs-var">fstep</span></a><span> </span><a href="#local-6989586621679161310"><span class="hs-identifier hs-var">fs</span></a><span> </span><a href="#local-6989586621679161312"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="#local-6989586621679161273"><span class="hs-identifier hs-var">fextract</span></a><span>
</span><a name="line-483"></a><span>
</span><a name="line-484"></a><span class="hs-comment">-- This is the dual of &quot;nil&quot;.</span><span>
</span><a name="line-485"></a><span class="hs-comment">--</span><span>
</span><a name="line-486"></a><span class="hs-comment">-- | A parser that always fails with an error message without consuming</span><span>
</span><a name="line-487"></a><span class="hs-comment">-- any input.</span><span>
</span><a name="line-488"></a><span class="hs-comment">--</span><span>
</span><a name="line-489"></a><span class="hs-comment">-- /Internal/</span><span>
</span><a name="line-490"></a><span class="hs-comment">--</span><span>
</span><a name="line-491"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">die</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-492"></a><span class="hs-identifier">die</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span> </span><a href="#local-6989586621679161147"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-type">Parser</span></a><span> </span><a href="#local-6989586621679161147"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679161148"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679161149"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-493"></a><a name="die"><a href="Streamly.Internal.Data.Parser.Types.html#die"><span class="hs-identifier">die</span></a></a><span> </span><a name="local-6989586621679161313"><a href="#local-6989586621679161313"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-494"></a><span>    </span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-var">Parser</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Error"><span class="hs-identifier hs-var">Error</span></a><span> </span><a href="#local-6989586621679161313"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- step</span><span>
</span><a name="line-495"></a><span>           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>                  </span><span class="hs-comment">-- initial</span><span>
</span><a name="line-496"></a><span>           </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><a href="#local-6989586621679161313"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>          </span><span class="hs-comment">-- extract</span><span>
</span><a name="line-497"></a><span>
</span><a name="line-498"></a><span class="hs-comment">-- This is the dual of &quot;nilM&quot;.</span><span>
</span><a name="line-499"></a><span class="hs-comment">--</span><span>
</span><a name="line-500"></a><span class="hs-comment">-- | A parser that always fails with an effectful error message and without</span><span>
</span><a name="line-501"></a><span class="hs-comment">-- consuming any input.</span><span>
</span><a name="line-502"></a><span class="hs-comment">--</span><span>
</span><a name="line-503"></a><span class="hs-comment">-- /Internal/</span><span>
</span><a name="line-504"></a><span class="hs-comment">--</span><span>
</span><a name="line-505"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">dieM</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-506"></a><span class="hs-identifier">dieM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span> </span><a href="#local-6989586621679161144"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679161144"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-type">Parser</span></a><span> </span><a href="#local-6989586621679161144"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679161145"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679161146"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-507"></a><a name="dieM"><a href="Streamly.Internal.Data.Parser.Types.html#dieM"><span class="hs-identifier">dieM</span></a></a><span> </span><a name="local-6989586621679161314"><a href="#local-6989586621679161314"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-508"></a><span>    </span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-var">Parser</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Error"><span class="hs-identifier hs-var">Error</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679161314"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- step</span><span>
</span><a name="line-509"></a><span>           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>               </span><span class="hs-comment">-- initial</span><span>
</span><a name="line-510"></a><span>           </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679161314"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- extract</span><span>
</span><a name="line-511"></a><span>
</span><a name="line-512"></a><span class="hs-comment">-- Note: The default implementations of &quot;some&quot; and &quot;many&quot; loop infinitely</span><span>
</span><a name="line-513"></a><span class="hs-comment">-- because of the strict pattern match on both the arguments in applicative and</span><span>
</span><a name="line-514"></a><span class="hs-comment">-- alternative. With the direct style parser type we cannot use the mutually</span><span>
</span><a name="line-515"></a><span class="hs-comment">-- recursive definitions of &quot;some&quot; and &quot;many&quot;.</span><span>
</span><a name="line-516"></a><span class="hs-comment">--</span><span>
</span><a name="line-517"></a><span class="hs-comment">-- Note: With the direct style parser type, the list in &quot;some&quot; and &quot;many&quot; is</span><span>
</span><a name="line-518"></a><span class="hs-comment">-- accumulated strictly, it cannot be consumed lazily.</span><span>
</span><a name="line-519"></a><span>
</span><a name="line-520"></a><span class="hs-comment">-- | 'Alternative' instance using 'alt'.</span><span>
</span><a name="line-521"></a><span class="hs-comment">--</span><span>
</span><a name="line-522"></a><span class="hs-comment">-- Note: The implementation of '&lt;|&gt;' is not lazy in the second</span><span>
</span><a name="line-523"></a><span class="hs-comment">-- argument. The following code will fail:</span><span>
</span><a name="line-524"></a><span class="hs-comment">--</span><span>
</span><a name="line-525"></a><span class="hs-comment">-- &gt;&gt;&gt; S.parse (PR.satisfy (&gt; 0) &lt;|&gt; undefined) $ S.fromList [1..10]</span><span>
</span><a name="line-526"></a><span class="hs-comment">--</span><span>
</span><a name="line-527"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">MonadCatch</span><span> </span><a href="#local-6989586621679161119"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Alternative</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-type">Parser</span></a><span> </span><a href="#local-6989586621679161119"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679161120"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-528"></a><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">empty</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-529"></a><span>    </span><a name="local-8214565720323790442"><span class="hs-identifier">empty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#die"><span class="hs-identifier hs-var">die</span></a><span> </span><span class="hs-string">&quot;empty&quot;</span><span>
</span><a name="line-530"></a><span>
</span><a name="line-531"></a><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">(</span><span class="hs-pragma">&lt;|&gt;</span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-532"></a><span>    </span><span class="hs-special">(</span><a name="local-8214565720323790441"><span class="hs-operator">&lt;|&gt;</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#alt"><span class="hs-identifier hs-var">alt</span></a><span>
</span><a name="line-533"></a><span>
</span><a name="line-534"></a><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">many</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-535"></a><span>    </span><a name="local-8214565720323790439"><span class="hs-identifier">many</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#splitMany"><span class="hs-identifier hs-var">splitMany</span></a><span> </span><a href="Streamly.Internal.Data.Fold.html#toList"><span class="hs-identifier hs-var">toList</span></a><span>
</span><a name="line-536"></a><span>
</span><a name="line-537"></a><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">some</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-538"></a><span>    </span><a name="local-8214565720323790440"><span class="hs-identifier">some</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#splitSome"><span class="hs-identifier hs-var">splitSome</span></a><span> </span><a href="Streamly.Internal.Data.Fold.html#toList"><span class="hs-identifier hs-var">toList</span></a><span>
</span><a name="line-539"></a><span>
</span><a name="line-540"></a><span class="hs-pragma">{-# ANN</span><span> </span><span class="hs-pragma">type</span><span> </span><span class="hs-pragma">ConcatParseState</span><span> </span><span class="hs-pragma">Fuse</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-541"></a><span class="hs-keyword">data</span><span> </span><a name="ConcatParseState"><a href="Streamly.Internal.Data.Parser.Types.html#ConcatParseState"><span class="hs-identifier">ConcatParseState</span></a></a><span> </span><a name="local-6989586621679161067"><a href="#local-6989586621679161067"><span class="hs-identifier">sl</span></a></a><span> </span><a name="local-6989586621679161068"><a href="#local-6989586621679161068"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="ConcatParseL"><a href="Streamly.Internal.Data.Parser.Types.html#ConcatParseL"><span class="hs-identifier">ConcatParseL</span></a></a><span> </span><a href="#local-6989586621679161067"><span class="hs-identifier hs-type">sl</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="ConcatParseR"><a href="Streamly.Internal.Data.Parser.Types.html#ConcatParseR"><span class="hs-identifier">ConcatParseR</span></a></a><span> </span><a href="#local-6989586621679161068"><span class="hs-identifier hs-type">p</span></a><span>
</span><a name="line-542"></a><span>
</span><a name="line-543"></a><span class="hs-comment">-- Note: The monad instance has quadratic performance complexity. It works fine</span><span>
</span><a name="line-544"></a><span class="hs-comment">-- for small number of compositions but for a scalable implementation we need a</span><span>
</span><a name="line-545"></a><span class="hs-comment">-- CPS version.</span><span>
</span><a name="line-546"></a><span>
</span><a name="line-547"></a><span class="hs-comment">-- | Monad composition can be used for lookbehind parsers, we can make the</span><span>
</span><a name="line-548"></a><span class="hs-comment">-- future parses depend on the previously parsed values.</span><span>
</span><a name="line-549"></a><span class="hs-comment">--</span><span>
</span><a name="line-550"></a><span class="hs-comment">-- If we have to parse &quot;a9&quot; or &quot;9a&quot; but not &quot;99&quot; or &quot;aa&quot; we can use the</span><span>
</span><a name="line-551"></a><span class="hs-comment">-- following parser:</span><span>
</span><a name="line-552"></a><span class="hs-comment">--</span><span>
</span><a name="line-553"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-554"></a><span class="hs-comment">-- backtracking :: MonadCatch m =&gt; PR.Parser m Char String</span><span>
</span><a name="line-555"></a><span class="hs-comment">-- backtracking =</span><span>
</span><a name="line-556"></a><span class="hs-comment">--     sequence [PR.satisfy isDigit, PR.satisfy isAlpha]</span><span>
</span><a name="line-557"></a><span class="hs-comment">--     '&lt;|&gt;'</span><span>
</span><a name="line-558"></a><span class="hs-comment">--     sequence [PR.satisfy isAlpha, PR.satisfy isDigit]</span><span>
</span><a name="line-559"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-560"></a><span class="hs-comment">--</span><span>
</span><a name="line-561"></a><span class="hs-comment">-- We know that if the first parse resulted in a digit at the first place then</span><span>
</span><a name="line-562"></a><span class="hs-comment">-- the second parse is going to fail.  However, we waste that information and</span><span>
</span><a name="line-563"></a><span class="hs-comment">-- parse the first character again in the second parse only to know that it is</span><span>
</span><a name="line-564"></a><span class="hs-comment">-- not an alphabetic char.  By using lookbehind in a 'Monad' composition we can</span><span>
</span><a name="line-565"></a><span class="hs-comment">-- avoid redundant work:</span><span>
</span><a name="line-566"></a><span class="hs-comment">--</span><span>
</span><a name="line-567"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-568"></a><span class="hs-comment">-- data DigitOrAlpha = Digit Char | Alpha Char</span><span>
</span><a name="line-569"></a><span class="hs-comment">--</span><span>
</span><a name="line-570"></a><span class="hs-comment">-- lookbehind :: MonadCatch m =&gt; PR.Parser m Char String</span><span>
</span><a name="line-571"></a><span class="hs-comment">-- lookbehind = do</span><span>
</span><a name="line-572"></a><span class="hs-comment">--     x1 \&lt;-    Digit '&lt;$&gt;' PR.satisfy isDigit</span><span>
</span><a name="line-573"></a><span class="hs-comment">--          '&lt;|&gt;' Alpha '&lt;$&gt;' PR.satisfy isAlpha</span><span>
</span><a name="line-574"></a><span class="hs-comment">--</span><span>
</span><a name="line-575"></a><span class="hs-comment">--     -- Note: the parse depends on what we parsed already</span><span>
</span><a name="line-576"></a><span class="hs-comment">--     x2 &lt;- case x1 of</span><span>
</span><a name="line-577"></a><span class="hs-comment">--         Digit _ -&gt; PR.satisfy isAlpha</span><span>
</span><a name="line-578"></a><span class="hs-comment">--         Alpha _ -&gt; PR.satisfy isDigit</span><span>
</span><a name="line-579"></a><span class="hs-comment">--</span><span>
</span><a name="line-580"></a><span class="hs-comment">--     return $ case x1 of</span><span>
</span><a name="line-581"></a><span class="hs-comment">--         Digit x -&gt; [x,x2]</span><span>
</span><a name="line-582"></a><span class="hs-comment">--         Alpha x -&gt; [x,x2]</span><span>
</span><a name="line-583"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-584"></a><span class="hs-comment">--</span><span>
</span><a name="line-585"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679161082"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-type">Parser</span></a><span> </span><a href="#local-6989586621679161082"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679161083"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-586"></a><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">return</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-587"></a><span>    </span><a name="local-3458764513820541102"><span class="hs-identifier">return</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pure</span><span>
</span><a name="line-588"></a><span>
</span><a name="line-589"></a><span>    </span><span class="hs-comment">-- (&gt;&gt;=) :: Parser m a b -&gt; (b -&gt; Parser m a c) -&gt; Parser m a c</span><span>
</span><a name="line-590"></a><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">(</span><span class="hs-pragma">&gt;&gt;=</span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-591"></a><span>    </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-var">Parser</span></a><span> </span><a name="local-6989586621679161084"><a href="#local-6989586621679161084"><span class="hs-identifier">stepL</span></a></a><span> </span><a name="local-6989586621679161085"><a href="#local-6989586621679161085"><span class="hs-identifier">initialL</span></a></a><span> </span><a name="local-6989586621679161086"><a href="#local-6989586621679161086"><span class="hs-identifier">extractL</span></a></a><span class="hs-special">)</span><span> </span><a name="local-3458764513820541099"><span class="hs-operator">&gt;&gt;=</span></a><span> </span><a name="local-6989586621679161087"><a href="#local-6989586621679161087"><span class="hs-identifier">func</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-var">Parser</span></a><span> </span><a href="#local-6989586621679161089"><span class="hs-identifier hs-var">step</span></a><span> </span><a href="#local-6989586621679161088"><span class="hs-identifier hs-var">initial</span></a><span> </span><a href="#local-6989586621679161090"><span class="hs-identifier hs-var">extract</span></a><span>
</span><a name="line-592"></a><span>
</span><a name="line-593"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-594"></a><span>
</span><a name="line-595"></a><span>        </span><a name="local-6989586621679161088"><a href="#local-6989586621679161088"><span class="hs-identifier">initial</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#ConcatParseL"><span class="hs-identifier hs-var">ConcatParseL</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679161085"><span class="hs-identifier hs-var">initialL</span></a><span>
</span><a name="line-596"></a><span>
</span><a name="line-597"></a><span>        </span><a name="local-6989586621679161089"><a href="#local-6989586621679161089"><span class="hs-identifier">step</span></a></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#ConcatParseL"><span class="hs-identifier hs-var">ConcatParseL</span></a><span> </span><a name="local-6989586621679161091"><a href="#local-6989586621679161091"><span class="hs-identifier">st</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679161092"><a href="#local-6989586621679161092"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-598"></a><span>            </span><a name="local-6989586621679161093"><a href="#local-6989586621679161093"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679161084"><span class="hs-identifier hs-var">stepL</span></a><span> </span><a href="#local-6989586621679161091"><span class="hs-identifier hs-var">st</span></a><span> </span><a href="#local-6989586621679161092"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-599"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679161093"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-600"></a><span>                </span><a href="Streamly.Internal.Data.Parser.Types.html#Yield"><span class="hs-identifier hs-var">Yield</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679161094"><a href="#local-6989586621679161094"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Skip"><span class="hs-identifier hs-var">Skip</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#ConcatParseL"><span class="hs-identifier hs-var">ConcatParseL</span></a><span> </span><a href="#local-6989586621679161094"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-601"></a><span>                </span><a href="Streamly.Internal.Data.Parser.Types.html#Skip"><span class="hs-identifier hs-var">Skip</span></a><span> </span><a name="local-6989586621679161095"><a href="#local-6989586621679161095"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679161096"><a href="#local-6989586621679161096"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Skip"><span class="hs-identifier hs-var">Skip</span></a><span> </span><a href="#local-6989586621679161095"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#ConcatParseL"><span class="hs-identifier hs-var">ConcatParseL</span></a><span> </span><a href="#local-6989586621679161096"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-602"></a><span>                </span><a href="Streamly.Internal.Data.Parser.Types.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a name="local-6989586621679161097"><a href="#local-6989586621679161097"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679161098"><a href="#local-6989586621679161098"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Skip"><span class="hs-identifier hs-var">Skip</span></a><span> </span><a href="#local-6989586621679161097"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#ConcatParseR"><span class="hs-identifier hs-var">ConcatParseR</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679161087"><span class="hs-identifier hs-var">func</span></a><span> </span><a href="#local-6989586621679161098"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-603"></a><span>                </span><a href="Streamly.Internal.Data.Parser.Types.html#Error"><span class="hs-identifier hs-var">Error</span></a><span> </span><a name="local-6989586621679161099"><a href="#local-6989586621679161099"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Error"><span class="hs-identifier hs-var">Error</span></a><span> </span><a href="#local-6989586621679161099"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-604"></a><span>
</span><a name="line-605"></a><span>        </span><span class="hs-identifier">step</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#ConcatParseR"><span class="hs-identifier hs-var">ConcatParseR</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-var">Parser</span></a><span> </span><a name="local-6989586621679161100"><a href="#local-6989586621679161100"><span class="hs-identifier">stepR</span></a></a><span> </span><a name="local-6989586621679161101"><a href="#local-6989586621679161101"><span class="hs-identifier">initialR</span></a></a><span> </span><a name="local-6989586621679161102"><a href="#local-6989586621679161102"><span class="hs-identifier">extractR</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679161103"><a href="#local-6989586621679161103"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-606"></a><span>            </span><a name="local-6989586621679161104"><a href="#local-6989586621679161104"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679161101"><span class="hs-identifier hs-var">initialR</span></a><span>
</span><a name="line-607"></a><span>            </span><a name="local-6989586621679161105"><a href="#local-6989586621679161105"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679161100"><span class="hs-identifier hs-var">stepR</span></a><span> </span><a href="#local-6989586621679161104"><span class="hs-identifier hs-var">st</span></a><span> </span><a href="#local-6989586621679161103"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-608"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679161105"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-609"></a><span>                </span><a href="Streamly.Internal.Data.Parser.Types.html#Yield"><span class="hs-identifier hs-var">Yield</span></a><span> </span><a name="local-6989586621679161106"><a href="#local-6989586621679161106"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679161107"><a href="#local-6989586621679161107"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-610"></a><span>                    </span><a href="Streamly.Internal.Data.Parser.Types.html#Yield"><span class="hs-identifier hs-var">Yield</span></a><span> </span><a href="#local-6989586621679161106"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#ConcatParseR"><span class="hs-identifier hs-var">ConcatParseR</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-var">Parser</span></a><span> </span><a href="#local-6989586621679161100"><span class="hs-identifier hs-var">stepR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679161107"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679161102"><span class="hs-identifier hs-var">extractR</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-611"></a><span>                </span><a href="Streamly.Internal.Data.Parser.Types.html#Skip"><span class="hs-identifier hs-var">Skip</span></a><span> </span><a name="local-6989586621679161108"><a href="#local-6989586621679161108"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679161109"><a href="#local-6989586621679161109"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-612"></a><span>                    </span><a href="Streamly.Internal.Data.Parser.Types.html#Skip"><span class="hs-identifier hs-var">Skip</span></a><span> </span><a href="#local-6989586621679161108"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#ConcatParseR"><span class="hs-identifier hs-var">ConcatParseR</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-var">Parser</span></a><span> </span><a href="#local-6989586621679161100"><span class="hs-identifier hs-var">stepR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679161109"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679161102"><span class="hs-identifier hs-var">extractR</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-613"></a><span>                </span><a href="Streamly.Internal.Data.Parser.Types.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a name="local-6989586621679161110"><a href="#local-6989586621679161110"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679161111"><a href="#local-6989586621679161111"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a href="#local-6989586621679161110"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679161111"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-614"></a><span>                </span><a href="Streamly.Internal.Data.Parser.Types.html#Error"><span class="hs-identifier hs-var">Error</span></a><span> </span><a name="local-6989586621679161112"><a href="#local-6989586621679161112"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#Error"><span class="hs-identifier hs-var">Error</span></a><span> </span><a href="#local-6989586621679161112"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-615"></a><span>
</span><a name="line-616"></a><span>        </span><a name="local-6989586621679161090"><a href="#local-6989586621679161090"><span class="hs-identifier">extract</span></a></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#ConcatParseR"><span class="hs-identifier hs-var">ConcatParseR</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-var">Parser</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679161113"><a href="#local-6989586621679161113"><span class="hs-identifier">initialR</span></a></a><span> </span><a name="local-6989586621679161114"><a href="#local-6989586621679161114"><span class="hs-identifier">extractR</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-617"></a><span>            </span><a href="#local-6989586621679161113"><span class="hs-identifier hs-var">initialR</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="#local-6989586621679161114"><span class="hs-identifier hs-var">extractR</span></a><span>
</span><a name="line-618"></a><span>
</span><a name="line-619"></a><span>        </span><span class="hs-identifier">extract</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#ConcatParseL"><span class="hs-identifier hs-var">ConcatParseL</span></a><span> </span><a name="local-6989586621679161115"><a href="#local-6989586621679161115"><span class="hs-identifier">sL</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679161086"><span class="hs-identifier hs-var">extractL</span></a><span> </span><a href="#local-6989586621679161115"><span class="hs-identifier hs-var">sL</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="#local-6989586621679161116"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679161087"><span class="hs-identifier hs-var">func</span></a><span>
</span><a name="line-620"></a><span>
</span><a name="line-621"></a><span>            </span><span class="hs-keyword">where</span><span>
</span><a name="line-622"></a><span>
</span><a name="line-623"></a><span>            </span><a name="local-6989586621679161116"><a href="#local-6989586621679161116"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-var">Parser</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679161117"><a href="#local-6989586621679161117"><span class="hs-identifier">initialR</span></a></a><span> </span><a name="local-6989586621679161118"><a href="#local-6989586621679161118"><span class="hs-identifier">extractR</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679161117"><span class="hs-identifier hs-var">initialR</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="#local-6989586621679161118"><span class="hs-identifier hs-var">extractR</span></a><span>
</span><a name="line-624"></a><span>
</span><a name="line-625"></a><span class="hs-comment">-- | 'mzero' is same as 'empty', it aborts the parser. 'mplus' is same as</span><span>
</span><a name="line-626"></a><span class="hs-comment">-- '&lt;|&gt;', it selects the first succeeding parser.</span><span>
</span><a name="line-627"></a><span class="hs-comment">--</span><span>
</span><a name="line-628"></a><span class="hs-comment">-- /Internal/</span><span>
</span><a name="line-629"></a><span class="hs-comment">--</span><span>
</span><a name="line-630"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">MonadCatch</span><span> </span><a href="#local-6989586621679161080"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">MonadPlus</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Parser.Types.html#Parser"><span class="hs-identifier hs-type">Parser</span></a><span> </span><a href="#local-6989586621679161080"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679161081"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-631"></a><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">mzero</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-632"></a><span>    </span><a name="local-8214565720323790445"><span class="hs-identifier">mzero</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#die"><span class="hs-identifier hs-var">die</span></a><span> </span><span class="hs-string">&quot;mzero&quot;</span><span>
</span><a name="line-633"></a><span>
</span><a name="line-634"></a><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">mplus</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-635"></a><span>    </span><a name="local-8214565720323790444"><span class="hs-identifier">mplus</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Streamly.Internal.Data.Parser.Types.html#alt"><span class="hs-identifier hs-var">alt</span></a><span>
</span><a name="line-636"></a></pre></body></html>
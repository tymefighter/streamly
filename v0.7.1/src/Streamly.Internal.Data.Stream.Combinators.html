<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP                       #-}</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-cpp">#include &quot;inline.hs&quot;
</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- Module      : Streamly.Internal.Data.Stream.Combinators</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- Copyright   : (c) 2017 Harendra Kumar</span><span>
</span><a name="line-8"></a><span class="hs-comment">--</span><span>
</span><a name="line-9"></a><span class="hs-comment">-- License     : BSD3</span><span>
</span><a name="line-10"></a><span class="hs-comment">-- Maintainer  : streamly@composewell.com</span><span>
</span><a name="line-11"></a><span class="hs-comment">-- Stability   : experimental</span><span>
</span><a name="line-12"></a><span class="hs-comment">-- Portability : GHC</span><span>
</span><a name="line-13"></a><span class="hs-comment">--</span><span>
</span><a name="line-14"></a><span class="hs-comment">--</span><span>
</span><a name="line-15"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Streamly.Internal.Data.Stream.Combinators</span><span>
</span><a name="line-16"></a><span>    </span><span class="hs-special">(</span><span> </span><a href="Streamly.Internal.Data.Stream.Combinators.html#maxThreads"><span class="hs-identifier hs-var">maxThreads</span></a><span>
</span><a name="line-17"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Streamly.Internal.Data.Stream.Combinators.html#maxBuffer"><span class="hs-identifier hs-var">maxBuffer</span></a><span>
</span><a name="line-18"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Streamly.Internal.Data.Stream.Combinators.html#maxYields"><span class="hs-identifier hs-var">maxYields</span></a><span>
</span><a name="line-19"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Streamly.Internal.Data.Stream.Combinators.html#rate"><span class="hs-identifier hs-var">rate</span></a><span>
</span><a name="line-20"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Streamly.Internal.Data.Stream.Combinators.html#avgRate"><span class="hs-identifier hs-var">avgRate</span></a><span>
</span><a name="line-21"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Streamly.Internal.Data.Stream.Combinators.html#minRate"><span class="hs-identifier hs-var">minRate</span></a><span>
</span><a name="line-22"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Streamly.Internal.Data.Stream.Combinators.html#maxRate"><span class="hs-identifier hs-var">maxRate</span></a><span>
</span><a name="line-23"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Streamly.Internal.Data.Stream.Combinators.html#constRate"><span class="hs-identifier hs-var">constRate</span></a><span>
</span><a name="line-24"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Streamly.Internal.Data.Stream.Combinators.html#inspectMode"><span class="hs-identifier hs-var">inspectMode</span></a><span>
</span><a name="line-25"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Streamly.Internal.Data.Stream.Combinators.html#printState"><span class="hs-identifier hs-var">printState</span></a><span>
</span><a name="line-26"></a><span>    </span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span class="hs-keyword">where</span><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.IO.Class</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span class="hs-special">(</span><span class="hs-identifier hs-var">liftIO</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Int</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int64</span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="Streamly.Internal.Data.SVar.html"><span class="hs-identifier">Streamly.Internal.Data.SVar</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="Streamly.Internal.Data.Stream.StreamK.html"><span class="hs-identifier">Streamly.Internal.Data.Stream.StreamK</span></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="Streamly.Internal.Data.Stream.Serial.html"><span class="hs-identifier">Streamly.Internal.Data.Stream.Serial</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.Stream.Serial.html#SerialT"><span class="hs-identifier hs-type">SerialT</span></a><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-37"></a><span class="hs-comment">-- Concurrency control</span><span>
</span><a name="line-38"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-39"></a><span class="hs-comment">--</span><span>
</span><a name="line-40"></a><span class="hs-comment">-- XXX need to write these in direct style otherwise they will break fusion.</span><span>
</span><a name="line-41"></a><span class="hs-comment">--</span><span>
</span><a name="line-42"></a><span class="hs-comment">-- | Specify the maximum number of threads that can be spawned concurrently for</span><span>
</span><a name="line-43"></a><span class="hs-comment">-- any concurrent combinator in a stream.</span><span>
</span><a name="line-44"></a><span class="hs-comment">-- A value of 0 resets the thread limit to default, a negative value means</span><span>
</span><a name="line-45"></a><span class="hs-comment">-- there is no limit. The default value is 1500. 'maxThreads' does not affect</span><span>
</span><a name="line-46"></a><span class="hs-comment">-- 'ParallelT' streams as they can use unbounded number of threads.</span><span>
</span><a name="line-47"></a><span class="hs-comment">--</span><span>
</span><a name="line-48"></a><span class="hs-comment">-- When the actions in a stream are IO bound, having blocking IO calls, this</span><span>
</span><a name="line-49"></a><span class="hs-comment">-- option can be used to control the maximum number of in-flight IO requests.</span><span>
</span><a name="line-50"></a><span class="hs-comment">-- When the actions are CPU bound this option can be used to</span><span>
</span><a name="line-51"></a><span class="hs-comment">-- control the amount of CPU used by the stream.</span><span>
</span><a name="line-52"></a><span class="hs-comment">--</span><span>
</span><a name="line-53"></a><span class="hs-comment">-- @since 0.4.0</span><span>
</span><a name="line-54"></a><span class="hs-pragma">{-# INLINE_NORMAL maxThreads #-}</span><span>
</span><a name="line-55"></a><span class="hs-identifier">maxThreads</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#IsStream"><span class="hs-identifier hs-type">IsStream</span></a><span> </span><a href="#local-6989586621679218775"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679218775"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679218776"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679218777"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679218775"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679218776"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679218777"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-56"></a><a name="maxThreads"><a href="Streamly.Internal.Data.Stream.Combinators.html#maxThreads"><span class="hs-identifier">maxThreads</span></a></a><span> </span><a name="local-6989586621679218778"><a href="#local-6989586621679218778"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679218779"><a href="#local-6989586621679218779"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679218780"><a href="#local-6989586621679218780"><span class="hs-identifier">st</span></a></a><span> </span><a name="local-6989586621679218781"><a href="#local-6989586621679218781"><span class="hs-identifier">stp</span></a></a><span> </span><a name="local-6989586621679218782"><a href="#local-6989586621679218782"><span class="hs-identifier">sng</span></a></a><span> </span><a name="local-6989586621679218783"><a href="#local-6989586621679218783"><span class="hs-identifier">yld</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-57"></a><span>    </span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStreamShared"><span class="hs-identifier hs-var">foldStreamShared</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.SVar.html#setMaxThreads"><span class="hs-identifier hs-var">setMaxThreads</span></a><span> </span><a href="#local-6989586621679218778"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679218780"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679218781"><span class="hs-identifier hs-var">stp</span></a><span> </span><a href="#local-6989586621679218782"><span class="hs-identifier hs-var">sng</span></a><span> </span><a href="#local-6989586621679218783"><span class="hs-identifier hs-var">yld</span></a><span> </span><a href="#local-6989586621679218779"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-58"></a><span>
</span><a name="line-59"></a><span class="hs-comment">{-
{-# RULES &quot;maxThreadsSerial serial&quot; maxThreads = maxThreadsSerial #-}
maxThreadsSerial :: Int -&gt; SerialT m a -&gt; SerialT m a
maxThreadsSerial _ = id
-}</span><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span class="hs-comment">-- | Specify the maximum size of the buffer for storing the results from</span><span>
</span><a name="line-66"></a><span class="hs-comment">-- concurrent computations. If the buffer becomes full we stop spawning more</span><span>
</span><a name="line-67"></a><span class="hs-comment">-- concurrent tasks until there is space in the buffer.</span><span>
</span><a name="line-68"></a><span class="hs-comment">-- A value of 0 resets the buffer size to default, a negative value means</span><span>
</span><a name="line-69"></a><span class="hs-comment">-- there is no limit. The default value is 1500.</span><span>
</span><a name="line-70"></a><span class="hs-comment">--</span><span>
</span><a name="line-71"></a><span class="hs-comment">-- CAUTION! using an unbounded 'maxBuffer' value (i.e. a negative value)</span><span>
</span><a name="line-72"></a><span class="hs-comment">-- coupled with an unbounded 'maxThreads' value is a recipe for disaster in</span><span>
</span><a name="line-73"></a><span class="hs-comment">-- presence of infinite streams, or very large streams.  Especially, it must</span><span>
</span><a name="line-74"></a><span class="hs-comment">-- not be used when 'pure' is used in 'ZipAsyncM' streams as 'pure' in</span><span>
</span><a name="line-75"></a><span class="hs-comment">-- applicative zip streams generates an infinite stream causing unbounded</span><span>
</span><a name="line-76"></a><span class="hs-comment">-- concurrent generation with no limit on the buffer or threads.</span><span>
</span><a name="line-77"></a><span class="hs-comment">--</span><span>
</span><a name="line-78"></a><span class="hs-comment">-- @since 0.4.0</span><span>
</span><a name="line-79"></a><span class="hs-pragma">{-# INLINE_NORMAL maxBuffer #-}</span><span>
</span><a name="line-80"></a><span class="hs-identifier">maxBuffer</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#IsStream"><span class="hs-identifier hs-type">IsStream</span></a><span> </span><a href="#local-6989586621679218772"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679218772"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679218773"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679218774"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679218772"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679218773"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679218774"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-81"></a><a name="maxBuffer"><a href="Streamly.Internal.Data.Stream.Combinators.html#maxBuffer"><span class="hs-identifier">maxBuffer</span></a></a><span> </span><a name="local-6989586621679218784"><a href="#local-6989586621679218784"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679218785"><a href="#local-6989586621679218785"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679218786"><a href="#local-6989586621679218786"><span class="hs-identifier">st</span></a></a><span> </span><a name="local-6989586621679218787"><a href="#local-6989586621679218787"><span class="hs-identifier">stp</span></a></a><span> </span><a name="local-6989586621679218788"><a href="#local-6989586621679218788"><span class="hs-identifier">sng</span></a></a><span> </span><a name="local-6989586621679218789"><a href="#local-6989586621679218789"><span class="hs-identifier">yld</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-82"></a><span>    </span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStreamShared"><span class="hs-identifier hs-var">foldStreamShared</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.SVar.html#setMaxBuffer"><span class="hs-identifier hs-var">setMaxBuffer</span></a><span> </span><a href="#local-6989586621679218784"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679218786"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679218787"><span class="hs-identifier hs-var">stp</span></a><span> </span><a href="#local-6989586621679218788"><span class="hs-identifier hs-var">sng</span></a><span> </span><a href="#local-6989586621679218789"><span class="hs-identifier hs-var">yld</span></a><span> </span><a href="#local-6989586621679218785"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-83"></a><span>
</span><a name="line-84"></a><span class="hs-comment">{-
{-# RULES &quot;maxBuffer serial&quot; maxBuffer = maxBufferSerial #-}
maxBufferSerial :: Int -&gt; SerialT m a -&gt; SerialT m a
maxBufferSerial _ = id
-}</span><span>
</span><a name="line-89"></a><span>
</span><a name="line-90"></a><span class="hs-comment">-- | Specify the pull rate of a stream.</span><span>
</span><a name="line-91"></a><span class="hs-comment">-- A 'Nothing' value resets the rate to default which is unlimited.  When the</span><span>
</span><a name="line-92"></a><span class="hs-comment">-- rate is specified, concurrent production may be ramped up or down</span><span>
</span><a name="line-93"></a><span class="hs-comment">-- automatically to achieve the specified yield rate. The specific behavior for</span><span>
</span><a name="line-94"></a><span class="hs-comment">-- different styles of 'Rate' specifications is documented under 'Rate'.  The</span><span>
</span><a name="line-95"></a><span class="hs-comment">-- effective maximum production rate achieved by a stream is governed by:</span><span>
</span><a name="line-96"></a><span class="hs-comment">--</span><span>
</span><a name="line-97"></a><span class="hs-comment">-- * The 'maxThreads' limit</span><span>
</span><a name="line-98"></a><span class="hs-comment">-- * The 'maxBuffer' limit</span><span>
</span><a name="line-99"></a><span class="hs-comment">-- * The maximum rate that the stream producer can achieve</span><span>
</span><a name="line-100"></a><span class="hs-comment">-- * The maximum rate that the stream consumer can achieve</span><span>
</span><a name="line-101"></a><span class="hs-comment">--</span><span>
</span><a name="line-102"></a><span class="hs-comment">-- @since 0.5.0</span><span>
</span><a name="line-103"></a><span class="hs-pragma">{-# INLINE_NORMAL rate #-}</span><span>
</span><a name="line-104"></a><span class="hs-identifier">rate</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#IsStream"><span class="hs-identifier hs-type">IsStream</span></a><span> </span><a href="#local-6989586621679218769"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Streamly.Internal.Data.SVar.html#Rate"><span class="hs-identifier hs-type">Rate</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679218769"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679218770"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679218771"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679218769"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679218770"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679218771"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-105"></a><a name="rate"><a href="Streamly.Internal.Data.Stream.Combinators.html#rate"><span class="hs-identifier">rate</span></a></a><span> </span><a name="local-6989586621679218790"><a href="#local-6989586621679218790"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621679218791"><a href="#local-6989586621679218791"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679218792"><a href="#local-6989586621679218792"><span class="hs-identifier">st</span></a></a><span> </span><a name="local-6989586621679218793"><a href="#local-6989586621679218793"><span class="hs-identifier">stp</span></a></a><span> </span><a name="local-6989586621679218794"><a href="#local-6989586621679218794"><span class="hs-identifier">sng</span></a></a><span> </span><a name="local-6989586621679218795"><a href="#local-6989586621679218795"><span class="hs-identifier">yld</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-106"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679218790"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-107"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.SVar.html#Rate"><span class="hs-identifier hs-var">Rate</span></a><span> </span><a name="local-6989586621679218796"><a href="#local-6989586621679218796"><span class="hs-identifier">low</span></a></a><span> </span><a name="local-6989586621679218797"><a href="#local-6989586621679218797"><span class="hs-identifier">goal</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679218797"><span class="hs-identifier hs-var">goal</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679218796"><span class="hs-identifier hs-var">low</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-108"></a><span>            </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;rate: Target rate cannot be lower than minimum rate.&quot;</span><span>
</span><a name="line-109"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.SVar.html#Rate"><span class="hs-identifier hs-var">Rate</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679218798"><a href="#local-6989586621679218798"><span class="hs-identifier">goal</span></a></a><span> </span><a name="local-6989586621679218799"><a href="#local-6989586621679218799"><span class="hs-identifier">high</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679218798"><span class="hs-identifier hs-var">goal</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621679218799"><span class="hs-identifier hs-var">high</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-110"></a><span>            </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;rate: Target rate cannot be greater than maximum rate.&quot;</span><span>
</span><a name="line-111"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.SVar.html#Rate"><span class="hs-identifier hs-var">Rate</span></a><span> </span><a name="local-6989586621679218800"><a href="#local-6989586621679218800"><span class="hs-identifier">low</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679218801"><a href="#local-6989586621679218801"><span class="hs-identifier">high</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679218800"><span class="hs-identifier hs-var">low</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621679218801"><span class="hs-identifier hs-var">high</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-112"></a><span>            </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;rate: Minimum rate cannot be greater than maximum rate.&quot;</span><span>
</span><a name="line-113"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStreamShared"><span class="hs-identifier hs-var">foldStreamShared</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.SVar.html#setStreamRate"><span class="hs-identifier hs-var">setStreamRate</span></a><span> </span><a href="#local-6989586621679218790"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621679218792"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679218793"><span class="hs-identifier hs-var">stp</span></a><span> </span><a href="#local-6989586621679218794"><span class="hs-identifier hs-var">sng</span></a><span> </span><a href="#local-6989586621679218795"><span class="hs-identifier hs-var">yld</span></a><span> </span><a href="#local-6989586621679218791"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-114"></a><span>
</span><a name="line-115"></a><span class="hs-comment">-- XXX implement for serial streams as well, as a simple delay</span><span>
</span><a name="line-116"></a><span>
</span><a name="line-117"></a><span class="hs-comment">{-
{-# RULES &quot;rate serial&quot; rate = yieldRateSerial #-}
yieldRateSerial :: Double -&gt; SerialT m a -&gt; SerialT m a
yieldRateSerial _ = id
-}</span><span>
</span><a name="line-122"></a><span>
</span><a name="line-123"></a><span class="hs-comment">-- | Same as @rate (Just $ Rate (r/2) r (2*r) maxBound)@</span><span>
</span><a name="line-124"></a><span class="hs-comment">--</span><span>
</span><a name="line-125"></a><span class="hs-comment">-- Specifies the average production rate of a stream in number of yields</span><span>
</span><a name="line-126"></a><span class="hs-comment">-- per second (i.e.  @Hertz@).  Concurrent production is ramped up or down</span><span>
</span><a name="line-127"></a><span class="hs-comment">-- automatically to achieve the specified average yield rate. The rate can</span><span>
</span><a name="line-128"></a><span class="hs-comment">-- go down to half of the specified rate on the lower side and double of</span><span>
</span><a name="line-129"></a><span class="hs-comment">-- the specified rate on the higher side.</span><span>
</span><a name="line-130"></a><span class="hs-comment">--</span><span>
</span><a name="line-131"></a><span class="hs-comment">-- @since 0.5.0</span><span>
</span><a name="line-132"></a><span class="hs-identifier">avgRate</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#IsStream"><span class="hs-identifier hs-type">IsStream</span></a><span> </span><a href="#local-6989586621679218766"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Double</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679218766"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679218767"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679218768"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679218766"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679218767"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679218768"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-133"></a><a name="avgRate"><a href="Streamly.Internal.Data.Stream.Combinators.html#avgRate"><span class="hs-identifier">avgRate</span></a></a><span> </span><a name="local-6989586621679218802"><a href="#local-6989586621679218802"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Streamly.Internal.Data.Stream.Combinators.html#rate"><span class="hs-identifier hs-var">rate</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Streamly.Internal.Data.SVar.html#Rate"><span class="hs-identifier hs-var">Rate</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679218802"><span class="hs-identifier hs-var">r</span></a><span class="hs-operator hs-var">/</span><span class="hs-number">2</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679218802"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><span class="hs-number">2</span><span class="hs-operator hs-var">*</span><a href="#local-6989586621679218802"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">maxBound</span><span class="hs-special">)</span><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span class="hs-comment">-- | Same as @rate (Just $ Rate r r (2*r) maxBound)@</span><span>
</span><a name="line-136"></a><span class="hs-comment">--</span><span>
</span><a name="line-137"></a><span class="hs-comment">-- Specifies the minimum rate at which the stream should yield values. As</span><span>
</span><a name="line-138"></a><span class="hs-comment">-- far as possible the yield rate would never be allowed to go below the</span><span>
</span><a name="line-139"></a><span class="hs-comment">-- specified rate, even though it may possibly go above it at times, the</span><span>
</span><a name="line-140"></a><span class="hs-comment">-- upper limit is double of the specified rate.</span><span>
</span><a name="line-141"></a><span class="hs-comment">--</span><span>
</span><a name="line-142"></a><span class="hs-comment">-- @since 0.5.0</span><span>
</span><a name="line-143"></a><span class="hs-identifier">minRate</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#IsStream"><span class="hs-identifier hs-type">IsStream</span></a><span> </span><a href="#local-6989586621679218763"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Double</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679218763"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679218764"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679218765"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679218763"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679218764"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679218765"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-144"></a><a name="minRate"><a href="Streamly.Internal.Data.Stream.Combinators.html#minRate"><span class="hs-identifier">minRate</span></a></a><span> </span><a name="local-6989586621679218803"><a href="#local-6989586621679218803"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Streamly.Internal.Data.Stream.Combinators.html#rate"><span class="hs-identifier hs-var">rate</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Streamly.Internal.Data.SVar.html#Rate"><span class="hs-identifier hs-var">Rate</span></a><span> </span><a href="#local-6989586621679218803"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621679218803"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><span class="hs-number">2</span><span class="hs-operator hs-var">*</span><a href="#local-6989586621679218803"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">maxBound</span><span class="hs-special">)</span><span>
</span><a name="line-145"></a><span>
</span><a name="line-146"></a><span class="hs-comment">-- | Same as @rate (Just $ Rate (r/2) r r maxBound)@</span><span>
</span><a name="line-147"></a><span class="hs-comment">--</span><span>
</span><a name="line-148"></a><span class="hs-comment">-- Specifies the maximum rate at which the stream should yield values. As</span><span>
</span><a name="line-149"></a><span class="hs-comment">-- far as possible the yield rate would never be allowed to go above the</span><span>
</span><a name="line-150"></a><span class="hs-comment">-- specified rate, even though it may possibly go below it at times, the</span><span>
</span><a name="line-151"></a><span class="hs-comment">-- lower limit is half of the specified rate. This can be useful in</span><span>
</span><a name="line-152"></a><span class="hs-comment">-- applications where certain resource usage must not be allowed to go</span><span>
</span><a name="line-153"></a><span class="hs-comment">-- beyond certain limits.</span><span>
</span><a name="line-154"></a><span class="hs-comment">--</span><span>
</span><a name="line-155"></a><span class="hs-comment">-- @since 0.5.0</span><span>
</span><a name="line-156"></a><span class="hs-identifier">maxRate</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#IsStream"><span class="hs-identifier hs-type">IsStream</span></a><span> </span><a href="#local-6989586621679218760"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Double</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679218760"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679218761"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679218762"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679218760"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679218761"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679218762"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-157"></a><a name="maxRate"><a href="Streamly.Internal.Data.Stream.Combinators.html#maxRate"><span class="hs-identifier">maxRate</span></a></a><span> </span><a name="local-6989586621679218804"><a href="#local-6989586621679218804"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Streamly.Internal.Data.Stream.Combinators.html#rate"><span class="hs-identifier hs-var">rate</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Streamly.Internal.Data.SVar.html#Rate"><span class="hs-identifier hs-var">Rate</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679218804"><span class="hs-identifier hs-var">r</span></a><span class="hs-operator hs-var">/</span><span class="hs-number">2</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679218804"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621679218804"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-identifier hs-var">maxBound</span><span class="hs-special">)</span><span>
</span><a name="line-158"></a><span>
</span><a name="line-159"></a><span class="hs-comment">-- | Same as @rate (Just $ Rate r r r 0)@</span><span>
</span><a name="line-160"></a><span class="hs-comment">--</span><span>
</span><a name="line-161"></a><span class="hs-comment">-- Specifies a constant yield rate. If for some reason the actual rate</span><span>
</span><a name="line-162"></a><span class="hs-comment">-- goes above or below the specified rate we do not try to recover it by</span><span>
</span><a name="line-163"></a><span class="hs-comment">-- increasing or decreasing the rate in future.  This can be useful in</span><span>
</span><a name="line-164"></a><span class="hs-comment">-- applications like graphics frame refresh where we need to maintain a</span><span>
</span><a name="line-165"></a><span class="hs-comment">-- constant refresh rate.</span><span>
</span><a name="line-166"></a><span class="hs-comment">--</span><span>
</span><a name="line-167"></a><span class="hs-comment">-- @since 0.5.0</span><span>
</span><a name="line-168"></a><span class="hs-identifier">constRate</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#IsStream"><span class="hs-identifier hs-type">IsStream</span></a><span> </span><a href="#local-6989586621679218757"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Double</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679218757"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679218758"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679218759"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679218757"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679218758"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679218759"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-169"></a><a name="constRate"><a href="Streamly.Internal.Data.Stream.Combinators.html#constRate"><span class="hs-identifier">constRate</span></a></a><span> </span><a name="local-6989586621679218805"><a href="#local-6989586621679218805"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Streamly.Internal.Data.Stream.Combinators.html#rate"><span class="hs-identifier hs-var">rate</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Streamly.Internal.Data.SVar.html#Rate"><span class="hs-identifier hs-var">Rate</span></a><span> </span><a href="#local-6989586621679218805"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621679218805"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621679218805"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-170"></a><span>
</span><a name="line-171"></a><span class="hs-comment">-- | Specify the average latency, in nanoseconds, of a single threaded action</span><span>
</span><a name="line-172"></a><span class="hs-comment">-- in a concurrent composition. Streamly can measure the latencies, but that is</span><span>
</span><a name="line-173"></a><span class="hs-comment">-- possible only after at least one task has completed. This combinator can be</span><span>
</span><a name="line-174"></a><span class="hs-comment">-- used to provide a latency hint so that rate control using 'rate' can take</span><span>
</span><a name="line-175"></a><span class="hs-comment">-- that into account right from the beginning. When not specified then a</span><span>
</span><a name="line-176"></a><span class="hs-comment">-- default behavior is chosen which could be too slow or too fast, and would be</span><span>
</span><a name="line-177"></a><span class="hs-comment">-- restricted by any other control parameters configured.</span><span>
</span><a name="line-178"></a><span class="hs-comment">-- A value of 0 indicates default behavior, a negative value means there is no</span><span>
</span><a name="line-179"></a><span class="hs-comment">-- limit i.e. zero latency.</span><span>
</span><a name="line-180"></a><span class="hs-comment">-- This would normally be useful only in high latency and high throughput</span><span>
</span><a name="line-181"></a><span class="hs-comment">-- cases.</span><span>
</span><a name="line-182"></a><span class="hs-comment">--</span><span>
</span><a name="line-183"></a><span class="hs-pragma">{-# INLINE_NORMAL _serialLatency #-}</span><span>
</span><a name="line-184"></a><span class="hs-identifier">_serialLatency</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#IsStream"><span class="hs-identifier hs-type">IsStream</span></a><span> </span><a href="#local-6989586621679218754"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679218754"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679218755"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679218756"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679218754"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679218755"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679218756"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-185"></a><a name="_serialLatency"><a href="Streamly.Internal.Data.Stream.Combinators.html#_serialLatency"><span class="hs-identifier">_serialLatency</span></a></a><span> </span><a name="local-6989586621679218806"><a href="#local-6989586621679218806"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679218807"><a href="#local-6989586621679218807"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679218808"><a href="#local-6989586621679218808"><span class="hs-identifier">st</span></a></a><span> </span><a name="local-6989586621679218809"><a href="#local-6989586621679218809"><span class="hs-identifier">stp</span></a></a><span> </span><a name="local-6989586621679218810"><a href="#local-6989586621679218810"><span class="hs-identifier">sng</span></a></a><span> </span><a name="local-6989586621679218811"><a href="#local-6989586621679218811"><span class="hs-identifier">yld</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-186"></a><span>    </span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStreamShared"><span class="hs-identifier hs-var">foldStreamShared</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.SVar.html#setStreamLatency"><span class="hs-identifier hs-var">setStreamLatency</span></a><span> </span><a href="#local-6989586621679218806"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679218808"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679218809"><span class="hs-identifier hs-var">stp</span></a><span> </span><a href="#local-6989586621679218810"><span class="hs-identifier hs-var">sng</span></a><span> </span><a href="#local-6989586621679218811"><span class="hs-identifier hs-var">yld</span></a><span> </span><a href="#local-6989586621679218807"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-187"></a><span>
</span><a name="line-188"></a><span class="hs-comment">{-
{-# RULES &quot;serialLatency serial&quot; _serialLatency = serialLatencySerial #-}
serialLatencySerial :: Int -&gt; SerialT m a -&gt; SerialT m a
serialLatencySerial _ = id
-}</span><span>
</span><a name="line-193"></a><span>
</span><a name="line-194"></a><span class="hs-comment">-- Stop concurrent dispatches after this limit. This is useful in API's like</span><span>
</span><a name="line-195"></a><span class="hs-comment">-- &quot;take&quot; where we want to dispatch only upto the number of elements &quot;take&quot;</span><span>
</span><a name="line-196"></a><span class="hs-comment">-- needs.  This value applies only to the immediate next level and is not</span><span>
</span><a name="line-197"></a><span class="hs-comment">-- inherited by everything in enclosed scope.</span><span>
</span><a name="line-198"></a><span class="hs-pragma">{-# INLINE_NORMAL maxYields #-}</span><span>
</span><a name="line-199"></a><span class="hs-identifier">maxYields</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#IsStream"><span class="hs-identifier hs-type">IsStream</span></a><span> </span><a href="#local-6989586621679218751"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int64</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679218751"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679218752"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679218753"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679218751"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679218752"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679218753"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-200"></a><a name="maxYields"><a href="Streamly.Internal.Data.Stream.Combinators.html#maxYields"><span class="hs-identifier">maxYields</span></a></a><span> </span><a name="local-6989586621679218812"><a href="#local-6989586621679218812"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679218813"><a href="#local-6989586621679218813"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679218814"><a href="#local-6989586621679218814"><span class="hs-identifier">st</span></a></a><span> </span><a name="local-6989586621679218815"><a href="#local-6989586621679218815"><span class="hs-identifier">stp</span></a></a><span> </span><a name="local-6989586621679218816"><a href="#local-6989586621679218816"><span class="hs-identifier">sng</span></a></a><span> </span><a name="local-6989586621679218817"><a href="#local-6989586621679218817"><span class="hs-identifier">yld</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-201"></a><span>    </span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStreamShared"><span class="hs-identifier hs-var">foldStreamShared</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.SVar.html#setYieldLimit"><span class="hs-identifier hs-var">setYieldLimit</span></a><span> </span><a href="#local-6989586621679218812"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679218814"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679218815"><span class="hs-identifier hs-var">stp</span></a><span> </span><a href="#local-6989586621679218816"><span class="hs-identifier hs-var">sng</span></a><span> </span><a href="#local-6989586621679218817"><span class="hs-identifier hs-var">yld</span></a><span> </span><a href="#local-6989586621679218813"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-202"></a><span>
</span><a name="line-203"></a><span class="hs-pragma">{-# RULES</span><span> </span><span class="hs-pragma">&quot;maxYields serial&quot;</span><span> </span><span class="hs-pragma">maxYields</span><span> </span><span class="hs-pragma">=</span><span> </span><span class="hs-pragma">maxYieldsSerial</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-204"></a><span class="hs-identifier">maxYieldsSerial</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int64</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Stream.Serial.html#SerialT"><span class="hs-identifier hs-type">SerialT</span></a><span> </span><a href="#local-6989586621679218749"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679218750"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.Stream.Serial.html#SerialT"><span class="hs-identifier hs-type">SerialT</span></a><span> </span><a href="#local-6989586621679218749"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679218750"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-205"></a><a name="maxYieldsSerial"><a href="Streamly.Internal.Data.Stream.Combinators.html#maxYieldsSerial"><span class="hs-identifier">maxYieldsSerial</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-206"></a><span>
</span><a name="line-207"></a><span class="hs-identifier">printState</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679218747"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Streamly.Internal.Data.SVar.html#State"><span class="hs-identifier hs-type">State</span></a><span> </span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a><span> </span><a href="#local-6989586621679218747"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679218748"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679218747"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-208"></a><a name="printState"><a href="Streamly.Internal.Data.Stream.Combinators.html#printState"><span class="hs-identifier">printState</span></a></a><span> </span><a name="local-6989586621679218818"><a href="#local-6989586621679218818"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-209"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679218819"><a href="#local-6989586621679218819"><span class="hs-identifier">msv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">streamVar</span><span> </span><a href="#local-6989586621679218818"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-210"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679218819"><span class="hs-identifier hs-var">msv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-211"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679218820"><a href="#local-6989586621679218820"><span class="hs-identifier">sv</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Streamly.Internal.Data.SVar.html#dumpSVar"><span class="hs-identifier hs-var">dumpSVar</span></a><span> </span><a href="#local-6989586621679218820"><span class="hs-identifier hs-var">sv</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">putStrLn</span><span>
</span><a name="line-212"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">putStrLn</span><span> </span><span class="hs-string">&quot;No SVar&quot;</span><span>
</span><a name="line-213"></a><span>
</span><a name="line-214"></a><span class="hs-comment">-- | Print debug information about an SVar when the stream ends</span><span>
</span><a name="line-215"></a><span class="hs-identifier">inspectMode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#IsStream"><span class="hs-identifier hs-type">IsStream</span></a><span> </span><a href="#local-6989586621679218744"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679218744"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679218745"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679218746"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679218744"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679218745"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679218746"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-216"></a><a name="inspectMode"><a href="Streamly.Internal.Data.Stream.Combinators.html#inspectMode"><span class="hs-identifier">inspectMode</span></a></a><span> </span><a name="local-6989586621679218821"><a href="#local-6989586621679218821"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679218822"><a href="#local-6989586621679218822"><span class="hs-identifier">st</span></a></a><span> </span><a name="local-6989586621679218823"><a href="#local-6989586621679218823"><span class="hs-identifier">stp</span></a></a><span> </span><a name="local-6989586621679218824"><a href="#local-6989586621679218824"><span class="hs-identifier">sng</span></a></a><span> </span><a name="local-6989586621679218825"><a href="#local-6989586621679218825"><span class="hs-identifier">yld</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-217"></a><span>     </span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStreamShared"><span class="hs-identifier hs-var">foldStreamShared</span></a><span> </span><span class="hs-special">(</span><a href="Streamly.Internal.Data.SVar.html#setInspectMode"><span class="hs-identifier hs-var">setInspectMode</span></a><span> </span><a href="#local-6989586621679218822"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679218823"><span class="hs-identifier hs-var">stp</span></a><span> </span><a href="#local-6989586621679218824"><span class="hs-identifier hs-var">sng</span></a><span> </span><a href="#local-6989586621679218825"><span class="hs-identifier hs-var">yld</span></a><span> </span><a href="#local-6989586621679218821"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-218"></a></pre></body></html>